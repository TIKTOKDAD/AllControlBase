# 通用控制器需求文档 - 功能需求

> 版本: v3.17

## 1. 核心功能

### F1: 轨迹跟踪
- **F1.1**: 系统应跟踪 Hard Head 输出的 XYZ 轨迹
- **F1.2**: 跟踪误差应小于 0.3m (横向) 和 0.5m (纵向)
- **F1.3**: 支持 2D 轨迹 (车辆) 和 3D 轨迹 (无人机)

### F2: Hard/Soft 多维一致性融合

- **F2.1**: 一致性判断应综合多个维度：
  - 曲率一致性: |κ_hard - κ_soft| < κ_thresh
  - 速度方向一致性: dot(v_hard, v_soft) / (|v_hard| × |v_soft|) > v_dir_thresh
  - 时序平滑性: |soft[t] - soft[t-1]| < temporal_smooth_thresh

- **F2.2**: 融合权重计算 (加权几何平均)：
  ```
  α = (κ_consistency^w1 × v_dir_consistency^w2 × temporal_smooth^w3)^(1/(w1+w2+w3)) × confidence
  
  默认权重: w1=1.0, w2=1.5, w3=0.8
  confidence 范围: [0.0, 1.0]，超出范围会被 clip
  ```

- **F2.3**: 当 α < alpha_min 时，应自动禁用 Soft Head
- **F2.4**: 一致性指标应发布到诊断话题
- **F2.5**: data_valid 应综合所有维度的有效性

### F3: 延迟补偿
- **F3.1**: 系统应补偿网络推理延迟 (典型值: 30-100ms)
- **F3.2**: 使用 TF2 lookupTransform 获取坐标变换
- **F3.3**: TF2 降级策略：
  - 降级到 odom 积分时记录持续时间
  - 降级超过 500ms 触发更高级别警告
  - TF2 恢复后执行状态校正
- **F3.4**: TF2 降级超过 1000ms 应触发 MPC_DEGRADED 状态
- **F3.5**: TF2 恢复时应校正状态估计器的漂移

### F4: 约束满足
- **F4.1**: 输出速度应在 [v_min, v_max] 范围内
- **F4.2**: 输出角速度应在 [-ω_max, ω_max] 范围内
- **F4.3**: 加速度应在 [a_min, a_max] 范围内
- **F4.4**: 曲率应满足车辆运动学约束 (κ ≤ tan(δ_max)/L)
- **F4.5**: 低速时 (v < v_low_thresh) 应限制角速度为 omega_max_low
- **F4.6**: 全向车应分别约束 vx, vy 在 [vx_min, vx_max], [vy_min, vy_max] 范围内

### F5: 输出平滑
- **F5.1**: 控制量变化率应受限，避免抖动
- **F5.2**: 连续两帧输出的速度变化应 ≤ a_max × dt
- **F5.3**: 连续两帧输出的角速度变化应 ≤ α_max × dt
- **F5.4**: 全向车/无人机应分别限制各速度分量 (vx, vy, vz) 的变化率
- **F5.5**: 停车时应平滑减速，各分量独立减速到零

---

## 2. 状态估计功能

### F6: 自适应 EKF 状态估计
- **F6.1**: 融合 odom 和 IMU 数据，输出滤波后的状态
- **F6.2**: 自适应打滑检测
- **F6.3**: 动态调整 odom 协方差
- **F6.4**: 检测 IMU 漂移
- **F6.5**: 状态估计频率 ≥ 100Hz
- **F6.6**: 输出协方差范数、新息范数、IMU bias、打滑概率
- **F6.7**: IMU 超时时降级到纯 odom 估计
- **F6.8**: Odom twist 从机体坐标系转换到世界坐标系
- **F6.9**: 根据平台类型应用不同的运动学约束
- **F6.10**: 观测模型采用方案B，观测值为世界坐标系速度，H 矩阵简化
- **F6.11**: 根据 θ 协方差动态调整速度观测噪声
- **F6.12**: Kalman 更新后归一化航向角
- **F6.13**: 首次 IMU 更新时跳过打滑检测，等待 world_accel_vec 初始化
- **F6.14**: 支持外部漂移校正接口
- **F6.15**: 支持使用 odom orientation 作为航向备选 (v3.17 新增)

---

## 3. 安全功能

### F7: 超时监控
- **F7.1**: 当 odom 超时 (> 200ms) 时，应立即进入停车状态
- **F7.2**: 当 traj 超时 (> 200ms) 时，应在宽限期 (100ms) 内使用旧轨迹
- **F7.3**: 超过宽限期后，应进入停车状态
- **F7.4**: 当 IMU 超时 (> 100ms) 时，降级到纯 odom 估计
- **F7.5**: STOPPING 状态超时 (> 5s) 后强制进入 STOPPED
- **F7.6**: 系统启动时有初始化宽限期 (默认 1000ms)，期间不判定超时
- **F7.7**: 启动宽限期内 age_ms 返回 0.0 而非 inf

### F8: 渐进式降级
- **F8.1**: 系统应支持 7 级状态
- **F8.2**: 状态转换规则（详见状态机文档）
- **F8.3**: MPC_DEGRADED 状态下降低 horizon
- **F8.4**: 恢复规则（详见状态机文档）
- **F8.5**: MPC 突然完全失败时，NORMAL 可直接转换到 BACKUP_ACTIVE
- **F8.6**: SOFT_DISABLED 恢复到 NORMAL 前需检查 MPC 健康状态
- **F8.7**: STOPPED 恢复时需检查 MPC 健康状态
- **F8.8**: 安全检查失败时应立即触发状态转换 (v3.17 修复)

### F9: 备用控制器
- **F9.1**: Pure Pursuit 控制器应始终在后台运行（热备）
- **F9.2**: 切换延迟应 < 1 个控制周期 (20ms)
- **F9.3**: 备用控制器应使用相同的轨迹输入
- **F9.4**: 备用控制器输出应满足相同的约束
- **F9.5**: 备用控制器应支持资源清理

### F10: 控制器平滑切换
- **F10.1**: MPC → Backup 切换时应平滑过渡
- **F10.2**: 过渡时间可配置 (默认 200ms)
- **F10.3**: 支持指数平滑和线性平滑两种模式
- **F10.4**: 过渡进度应发布到诊断话题

### F11: 安全停车
- **F11.1**: 停车时应平滑减速，减速度 ≤ 3 m/s²
- **F11.2**: 停车后应保持 v=0, ω=0
- **F11.3**: 收到有效数据后应能恢复运行
- **F11.4**: 无人机停车时分别检查水平和垂直速度

### F12: 安全监控 (v3.17 增强)
- **F12.1**: 检查速度是否超限
- **F12.2**: 检查角速度是否超限
- **F12.3**: 检查水平加速度是否超限
- **F12.4**: 检查垂直加速度是否超限
- **F12.5**: 检查角加速度是否超限
- **F12.6**: 安全检查失败时**立即**限制输出并触发状态转换

---

## 4. 平台适配

### F13: 跨平台支持
- **F13.1**: 支持阿克曼转向车辆
- **F13.2**: 支持差速驱动车辆
- **F13.3**: 支持全向移动车辆
- **F13.4**: 支持四旋翼无人机
- **F13.5**: 平台类型通过配置文件指定
- **F13.6**: 使用统一状态空间 + 约束掩码实现
- **F13.7**: EKF 根据平台类型应用不同的运动学约束
- **F13.8**: 全向车支持多种航向控制模式

### F14: 无人机增强支持
- **F14.1**: 提供独立的姿态内环接口
- **F14.2**: 支持 attitude rate 限制
- **F14.3**: 悬停时 yaw 漂移补偿
- **F14.4**: 位置-姿态解耦控制选项
