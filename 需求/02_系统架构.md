# 通用控制器需求文档 - 系统架构

> 版本: v3.17

## 1. 插件化架构设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ControllerManager                                │
│                      (核心调度 + 生命周期管理)                            │
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │ IStateEstimator │  │ITrajectoryTracker│  │  IConsistencyChecker   │  │
│  │   (可替换)      │  │    (可替换)      │  │      (可替换)          │  │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────────────┤  │
│  │ - EKFEstimator  │  │ - MPCController │  │ - RuleBasedChecker     │  │
│  │ - UKFEstimator  │  │ - PurePursuit   │  │ - LearningBasedChecker │  │
│  │ - ParticleFilter│  │ - StanleyCtrl   │  │                        │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │ ISafetyMonitor  │  │ ICoordTransform │  │  ISmoothTransition     │  │
│  │   (可替换)      │  │    (可替换)     │  │      (可替换)          │  │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────────────┤  │
│  │ - BasicMonitor  │  │ - TF2Transform  │  │ - ExponentialBlend     │  │
│  │ - AdvancedMonitor│ │ - OdomIntegrate │  │ - LinearBlend          │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
│                                                                         │
│  ┌─────────────────┐  ┌─────────────────┐                               │
│  │ TimeoutMonitor  │  │DiagnosticsPublisher│                            │
│  │   (超时检测)    │  │   (诊断发布)    │                               │
│  └─────────────────┘  └─────────────────┘                               │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. 数据流架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    网络层 (外部)                                 │
│              输出: LocalTrajectoryV4 消息                        │
│         (包含 Hard 轨迹 + 可选 Soft 速度建议)                    │
└─────────────────────────────────────────────────────────────────┘
                              │ /nn/local_traj
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   通用控制器 (本项目)                            │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │    State     │  │  Trajectory  │  │    Consistency       │  │
│  │  Estimator   │─►│  Processor   │─►│     Analyzer         │  │
│  │(自适应EKF)   │  │              │  │  (加权几何平均)      │  │
│  └──────▲───────┘  └──────────────┘  └──────────┬───────────┘  │
│         │                                       │              │
│  /state/odom                                    ▼              │
│  /state/imu        ┌──────────────┐  ┌──────────────────────┐  │
│                    │     MPC      │  │   MPC Health         │  │
│                    │   Solver     │◄─│   Monitor            │  │
│                    │  (ACADOS)    │  │  (预测性降级)        │  │
│                    └──────┬───────┘  └──────────────────────┘  │
│                           │                                    │
│                           ▼                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   Backup     │◄─│  Controller  │─►│  Smooth Transition   │  │
│  │  Controller  │  │  Selector    │  │                      │  │
│  │  (热备)      │  └──────────────┘  └──────────┬───────────┘  │
│  └──────────────┘                               │              │
│                                                 ▼              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   Timeout    │─►│   Safety     │─►│      Output          │  │
│  │   Monitor    │  │  Supervisor  │  │                      │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │ /cmd_unified
                              │ /controller/diagnostics
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   平台适配层 (外部)                              │
│         车辆: Twist → Ackermann    无人机: Twist → MAVROS       │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 核心组件说明

| 组件 | 职责 | 可替换实现 |
|------|------|-----------|
| IStateEstimator | 状态估计与滤波 | EKF, UKF, ParticleFilter |
| ITrajectoryTracker | 轨迹跟踪控制 | MPC, PurePursuit, Stanley |
| IConsistencyChecker | Hard/Soft 一致性检查 | RuleBased, LearningBased |
| ISafetyMonitor | 安全约束检查 | Basic, Advanced |
| ICoordTransform | 坐标变换 | TF2, OdomIntegrate |
| ISmoothTransition | 控制器切换平滑 | Exponential, Linear |
| TimeoutMonitor | 超时检测 | - |
| DiagnosticsPublisher | 诊断信息发布 | - |
