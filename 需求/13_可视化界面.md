# 通用控制器需求文档 - 可视化界面

> 版本: v1.0 | 日期: 2024-12-21

## 1. 概述

### 1.1 目标

提供一个实时可视化监控界面，让用户能够：
- 清晰了解系统当前运行状态和降级级别
- 监控 MPC 控制器健康状态
- 查看关键指标和警告信息
- 了解系统配置和运行环境

### 1.2 技术方案

- **框架**: PyQt5
- **图表**: matplotlib (嵌入 PyQt5)
- **刷新频率**: 10-20 Hz (可配置)
- **数据源**: ControllerManager 的 DiagnosticsV2 数据

---

## 2. 界面完整布局

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    Universal Controller Dashboard                                     v3.17.7   │
│                                                                                               [运行中] 49.8Hz   │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                 │
│  ══════════════════════════════════════════ 顶部状态栏 (始终显示) ══════════════════════════════════════════   │
│                                                                                                                 │
│  状态: [■ NORMAL]  控制器: [MPC]  平台: [差速车]  ROS: [✓]  ACADOS: [✓]  TF2: [✓]  IMU: [✓]  运行: 00:15:32   │
│                                                                                                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                         系统信息 (System Info)                                          │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                         │   │
│  │  运行环境                          控制策略                          平台配置                            │   │
│  │  ─────────────                    ─────────────                    ─────────────                        │   │
│  │  ROS环境:     ✓ 已连接            主控制器:   MPC (ACADOS)          平台类型:   差速车 (differential)    │   │
│  │  TF2可用:     ✓ 正常              备用控制器: Pure Pursuit          控制频率:   50 Hz                    │   │
│  │  ACADOS:      ✓ 已加载            当前使用:   ● MPC                 MPC Horizon: 20                      │   │
│  │  IMU输入:     ✓ 启用              Soft Head:  ✓ 启用                时间步长:   0.02s                    │   │
│  │                                                                                                         │   │
│  │  功能开关                          坐标系配置                        版本信息                            │   │
│  │  ─────────────                    ─────────────                    ─────────────                        │   │
│  │  自适应EKF:   ✓ 启用              目标坐标系:  odom                  控制器版本: v3.17.7                  │   │
│  │  打滑检测:    ✓ 启用              输出坐标系:  base_link (机体)      配置文件:   default_config.yaml      │   │
│  │  漂移校正:    ✓ 启用              TF2降级:     ○ 未降级              启动时间:   2024-12-21 14:30:00      │   │
│  │  航向备选:    ✓ 启用              降级持续:    0 ms                                                      │   │
│  │                                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  ┌──────────────────────────────────────────────┐  ┌──────────────────────────────────────────────────────┐   │
│  │              系统状态 (State)                 │  │                  MPC 健康状态                         │   │
│  ├──────────────────────────────────────────────┤  ├──────────────────────────────────────────────────────┤   │
│  │                                              │  │                                                      │   │
│  │      ┌────────────────────────────┐          │  │  求解时间                                            │   │
│  │      │                            │          │  │  ████████████░░░░░░░░  8.2 ms / 15 ms (警告)        │   │
│  │      │                            │          │  │                        [██████████] 54.7%            │   │
│  │      │          NORMAL            │          │  │                                                      │   │
│  │      │                            │          │  │  KKT 残差                                            │   │
│  │      │        正常运行            │          │  │  ████████░░░░░░░░░░░░  0.0012 / 0.001 (阈值)        │   │
│  │      │                            │          │  │                        [████████░░] 120%  ⚠️         │   │
│  │      │       [绿色背景]           │          │  │                                                      │   │
│  │      │                            │          │  │  条件数                                              │   │
│  │      └────────────────────────────┘          │  │  ██░░░░░░░░░░░░░░░░░░  1.2e5 / 1e8 (阈值)           │   │
│  │                                              │  │                        [██░░░░░░░░] 0.12%            │   │
│  │  状态持续时间: 00:14:28                      │  │                                                      │   │
│  │  上次状态变化: INIT → NORMAL                 │  │  连续警告次数:  0 / 3 (限制)                         │   │
│  │                                              │  │  连续良好次数:  12                                   │   │
│  │                                              │  │  Horizon:       20 (正常) / 10 (降级时)              │   │
│  │                                              │  │                                                      │   │
│  │                                              │  │  健康状态: ✓ 健康                                    │   │
│  │                                              │  │  降级警告: ○ 无                                      │   │
│  │                                              │  │  可恢复:   ✓ 是                                      │   │
│  │                                              │  │                                                      │   │
│  └──────────────────────────────────────────────┘  └──────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  ┌──────────────────────────────────────────────┐  ┌──────────────────────────────────────────────────────┐   │
│  │            降级状态 (7级状态机)               │  │                    超时监控                           │   │
│  ├──────────────────────────────────────────────┤  ├──────────────────────────────────────────────────────┤   │
│  │                                              │  │                                                      │   │
│  │  [○] 0. INIT           初始化               │  │  数据源超时状态                                      │   │
│  │      └─ 系统启动中，等待数据                 │  │  ─────────────────────────────────────               │   │
│  │                                              │  │                                                      │   │
│  │  [●] 1. NORMAL         正常运行  ← 当前     │  │  Odom:   ✓ 正常    12 ms  / 200 ms                   │   │
│  │      └─ MPC 正常工作，Soft 启用              │  │           ████░░░░░░░░░░░░░░░░░░░░  6.0%             │   │
│  │                                              │  │                                                      │   │
│  │  [○] 2. SOFT_DISABLED  Soft禁用             │  │  Traj:   ✓ 正常    45 ms  / 200 ms                   │   │
│  │      └─ α < 0.1，仅使用 Hard 轨迹            │  │           ██████████░░░░░░░░░░░░░░  22.5%            │   │
│  │                                              │  │                                                      │   │
│  │  [○] 3. MPC_DEGRADED   MPC降级              │  │  IMU:    ✓ 正常    8 ms   / 100 ms                   │   │
│  │      └─ Horizon 降低，性能下降               │  │           ████░░░░░░░░░░░░░░░░░░░░  8.0%             │   │
│  │                                              │  │                                                      │   │
│  │  [○] 4. BACKUP_ACTIVE  备用激活             │  │  宽限期状态                                          │   │
│  │      └─ Pure Pursuit 接管控制                │  │  ─────────────────────────────────────               │   │
│  │                                              │  │  启动宽限期:  ✓ 已过  (1000 ms 配置)                 │   │
│  │  [○] 5. STOPPING       停车中               │  │  轨迹宽限期:  ○ 未触发 (100 ms 配置)                 │   │
│  │      └─ 正在平滑减速                         │  │                                                      │   │
│  │                                              │  │  超时配置                                            │   │
│  │  [○] 6. STOPPED        已停车               │  │  ─────────────────────────────────────               │   │
│  │      └─ 速度为零，等待恢复                   │  │  Odom超时阈值:   200 ms                              │   │
│  │                                              │  │  Traj超时阈值:   200 ms                              │   │
│  │  恢复计数器                                  │  │  Traj宽限期:     100 ms                              │   │
│  │  ─────────────────────────────               │  │  IMU超时阈值:    100 ms                              │   │
│  │  Alpha恢复计数:  0 / 5                       │  │  启动宽限期:     1000 ms                             │   │
│  │  MPC恢复计数:    0 / 5                       │  │                                                      │   │
│  │                                              │  │                                                      │   │
│  └──────────────────────────────────────────────┘  └──────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  ┌──────────────────────────────────────────────┐  ┌──────────────────────────────────────────────────────┐   │
│  │               一致性分析                      │  │                   安全约束状态                        │   │
│  ├──────────────────────────────────────────────┤  ├──────────────────────────────────────────────────────┤   │
│  │                                              │  │                                                      │   │
│  │  融合权重 α_soft                             │  │  速度约束                                            │   │
│  │  ████████████████░░░░  0.82 / 1.0           │  │  ─────────────────────────────────────               │   │
│  │                                              │  │  v_max:      2.0 m/s      当前: 1.25 m/s            │   │
│  │  曲率一致性 (κ)                              │  │               ████████████████░░░░░░  62.5%          │   │
│  │  ██████████████░░░░░░  0.75 / 1.0           │  │  v_min:      0.0 m/s      ✓ 满足                     │   │
│  │  阈值: 0.5   Hard: 0.12   Soft: 0.15        │  │  omega_max:  2.0 rad/s    当前: 0.35 rad/s           │   │
│  │                                              │  │               ████░░░░░░░░░░░░░░░░░░  17.5%          │   │
│  │  速度方向一致性                              │  │                                                      │   │
│  │  ██████████████████░░  0.91 / 1.0           │  │  加速度约束                                          │   │
│  │  阈值: 0.8                                   │  │  ─────────────────────────────────────               │   │
│  │                                              │  │  a_max:      1.5 m/s²    当前: 0.8 m/s²             │   │
│  │  时序平滑性                                  │  │               ██████████░░░░░░░░░░░░  53.3%          │   │
│  │  ████████████████░░░░  0.85 / 1.0           │  │  az_max:     1.0 m/s²    当前: 0.0 m/s²             │   │
│  │  阈值: 0.5                                   │  │               ░░░░░░░░░░░░░░░░░░░░░░  0.0%           │   │
│  │                                              │  │  alpha_max:  3.0 rad/s²  当前: 0.5 rad/s²           │   │
│  │  权重配置                                    │  │               ████░░░░░░░░░░░░░░░░░░  16.7%          │   │
│  │  ─────────────────────────────               │  │                                                      │   │
│  │  曲率权重 (w1):    1.0                       │  │  低速保护                                            │   │
│  │  速度方向权重 (w2): 1.5                      │  │  ─────────────────────────────────────               │   │
│  │  时序权重 (w3):    0.8                       │  │  低速阈值:       0.1 m/s                             │   │
│  │                                              │  │  低速角速度限制: 1.0 rad/s                           │   │
│  │  状态                                        │  │  当前状态:       ○ 未触发 (v > 0.1)                  │   │
│  │  ─────────────────────────────               │  │                                                      │   │
│  │  Soft Head:   ✓ 启用                        │  │  安全裕度                                            │   │
│  │  数据有效:    ✓ 是                          │  │  ─────────────────────────────────────               │   │
│  │  禁用阈值:    0.1                            │  │  速度裕度:       110% (1.1x)                         │   │
│  │  当前 > 阈值: ✓ 是 (0.82 > 0.1)             │  │  加速度裕度:     150% (1.5x)                         │   │
│  │                                              │  │                                                      │   │
│  │                                              │  │  安全检查: ✓ 全部通过                                │   │
│  │                                              │  │  上次限制: 无                                        │   │
│  │                                              │  │                                                      │   │
│  └──────────────────────────────────────────────┘  └──────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  ┌──────────────────────────────────────────────┐  ┌──────────────────────────────────────────────────────┐   │
│  │                 轨迹信息                      │  │                    跟踪误差                           │   │
│  ├──────────────────────────────────────────────┤  ├──────────────────────────────────────────────────────┤   │
│  │                                              │  │                                                      │   │
│  │  Hard 轨迹 (必选)                            │  │  横向误差 (Lateral)                                  │   │
│  │  ─────────────────────────────               │  │  ████░░░░░░░░░░░░░░░░  0.08 m / 0.3 m (阈值)        │   │
│  │  轨迹点数:    20                             │  │                        [████░░░░░░] 26.7%            │   │
│  │  时间步长:    0.1 s                          │  │                                                      │   │
│  │  总时长:      2.0 s                          │  │  纵向误差 (Longitudinal)                             │   │
│  │  坐标系:      world                          │  │  ██████░░░░░░░░░░░░░░  0.15 m / 0.5 m (阈值)        │   │
│  │                                              │  │                        [██████░░░░] 30.0%            │   │
│  │  Soft 建议 (可选)                            │  │                                                      │   │
│  │  ─────────────────────────────               │  │  航向误差 (Heading)                                  │   │
│  │  启用状态:    ✓ 启用                        │  │  ██░░░░░░░░░░░░░░░░░░  0.05 rad (2.9°)              │   │
│  │  置信度:      0.85                           │  │                                                      │   │
│  │  融合权重 α:  0.82                           │  │  预测误差 (Prediction)                               │   │
│  │  速度点数:    20                             │  │  ████░░░░░░░░░░░░░░░░  0.12 m                        │   │
│  │                                              │  │                                                      │   │
│  │  轨迹模式                                    │  │  误差趋势                                            │   │
│  │  ─────────────────────────────               │  │  ─────────────────────────────────────               │   │
│  │  ● MODE_TRACK     跟踪模式                   │  │  横向:  ↓ 下降 (-0.02 m/s)                          │   │
│  │  ○ MODE_STOP      停车模式                   │  │  纵向:  → 稳定                                       │   │
│  │  ○ MODE_HOVER     悬停模式 (无人机)          │  │  航向:  ↓ 下降 (-0.01 rad/s)                        │   │
│  │  ○ MODE_EMERGENCY 紧急模式                   │  │                                                      │   │
│  │                                              │  │  跟踪质量评分                                        │   │
│  │  最近点信息                                  │  │  ─────────────────────────────────────               │   │
│  │  ─────────────────────────────               │  │  综合评分:  ████████████████░░░░  85.2%             │   │
│  │  最近点距离:  0.12 m                         │  │  评级:      良好 (Good)                              │   │
│  │  最近点索引:  3 / 20                         │  │                                                      │   │
│  │  前视距离:    1.2 m                          │  │                                                      │   │
│  │  前视点索引:  8 / 20                         │  │                                                      │   │
│  │                                              │  │                                                      │   │
│  └──────────────────────────────────────────────┘  └──────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  ┌──────────────────────────────────────────────┐  ┌──────────────────────────────────────────────────────┐   │
│  │                 控制输出                      │  │                 状态估计 (EKF)                        │   │
│  ├──────────────────────────────────────────────┤  ├──────────────────────────────────────────────────────┤   │
│  │                                              │  │                                                      │   │
│  │  速度命令                                    │  │  位置估计                                            │   │
│  │  ─────────────────────────────               │  │  ─────────────────────────────────────               │   │
│  │  vx:     1.25 m/s                            │  │  x:      12.35 m                                     │   │
│  │          ████████████████░░░░░░  62.5%       │  │  y:       5.67 m                                     │   │
│  │  vy:     0.00 m/s                            │  │  z:       0.00 m                                     │   │
│  │          ░░░░░░░░░░░░░░░░░░░░░░  0.0%        │  │                                                      │   │
│  │  vz:     0.00 m/s                            │  │  航向估计                                            │   │
│  │          ░░░░░░░░░░░░░░░░░░░░░░  0.0%        │  │  ─────────────────────────────────────               │   │
│  │  omega:  0.35 rad/s                          │  │  θ:      0.52 rad (29.8°)                            │   │
│  │          ████░░░░░░░░░░░░░░░░░░  17.5%       │  │  来源:   EKF 融合                                    │   │
│  │                                              │  │  备选:   ○ 未使用 odom orientation                   │   │
│  │  控制器信息                                  │  │                                                      │   │
│  │  ─────────────────────────────               │  │  速度估计 (世界坐标系)                               │   │
│  │  当前控制器:  MPC                            │  │  ─────────────────────────────────────               │   │
│  │  求解成功:    ✓ 是                          │  │  vx:     1.23 m/s                                    │   │
│  │  求解时间:    8.2 ms                         │  │  vy:     0.05 m/s                                    │   │
│  │                                              │  │  vz:     0.00 m/s                                    │   │
│  │  过渡状态                                    │  │  omega:  0.34 rad/s                                  │   │
│  │  ─────────────────────────────               │  │                                                      │   │
│  │  过渡中:      ○ 否                          │  │  滤波器健康                                          │   │
│  │  过渡进度:    100%                           │  │  ─────────────────────────────────────               │   │
│  │  过渡类型:    exponential                    │  │  协方差范数:   0.012                                 │   │
│  │                                              │  │  新息范数:     0.008                                 │   │
│  │  安全检查                                    │  │  打滑概率:     2.3%                                  │   │
│  │  ─────────────────────────────               │  │               ██░░░░░░░░░░░░░░░░░░░░                 │   │
│  │  安全检查:    ✓ 通过                        │  │  IMU 漂移:     ○ 未检测                              │   │
│  │  限制应用:    ○ 无                          │  │  IMU 可用:     ✓ 是                                  │   │
│  │                                              │  │                                                      │   │
│  │  输出坐标系:  base_link (机体)               │  │  IMU Bias 估计                                       │   │
│  │                                              │  │  ─────────────────────────────────────               │   │
│  │                                              │  │  bias_ax:  0.02 m/s²                                 │   │
│  │                                              │  │  bias_ay:  0.01 m/s²                                 │   │
│  │                                              │  │  bias_az:  0.03 m/s²                                 │   │
│  │                                              │  │                                                      │   │
│  └──────────────────────────────────────────────┘  └──────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    平台专用面板 (根据平台类型显示)                                       │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                         │   │
│  │  ┌─────────────────────────────────────────── 无人机姿态控制 (F14) ───────────────────────────────────┐ │   │
│  │  │  (仅当 platform = quadrotor 时显示)                                                                │ │   │
│  │  │                                                                                                    │ │   │
│  │  │  姿态命令                              姿态角速度限制                      悬停状态                 │ │   │
│  │  │  ─────────────                        ─────────────                      ─────────────             │ │   │
│  │  │  Roll:    0.05 rad (2.9°)             Roll Rate Max:   1.0 rad/s         悬停 Yaw:    0.50 rad    │ │   │
│  │  │  Pitch:  -0.12 rad (-6.9°)            Pitch Rate Max:  1.0 rad/s         Yaw 漂移补偿: ✓ 启用     │ │   │
│  │  │  Yaw:     0.52 rad (29.8°)            Yaw Rate Max:    0.5 rad/s         累计漂移:    0.02 rad    │ │   │
│  │  │  Thrust:  0.98 (归一化)                                                                            │ │   │
│  │  │                                                                                                    │ │   │
│  │  │  航向控制模式                          位置-姿态解耦                                                │ │   │
│  │  │  ─────────────                        ─────────────                                                │ │   │
│  │  │  ● velocity    跟随速度方向            解耦模式:  ✓ 启用                                           │ │   │
│  │  │  ○ fixed       固定航向                                                                            │ │   │
│  │  │  ○ target      朝向目标点                                                                          │ │   │
│  │  │  ○ manual      手动指定                                                                            │ │   │
│  │  │                                                                                                    │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                                                         │   │
│  │  ┌─────────────────────────────────────────── 全向车控制 ─────────────────────────────────────────────┐ │   │
│  │  │  (仅当 platform = omni 时显示)                                                                     │ │   │
│  │  │                                                                                                    │ │   │
│  │  │  独立速度约束                          航向控制模式                        外部航向输入             │ │   │
│  │  │  ─────────────                        ─────────────                      ─────────────             │ │   │
│  │  │  vx: -1.5 ~ 1.5 m/s   当前: 1.2       ● follow_velocity 跟随速度         启用状态: ○ 未启用       │ │   │
│  │  │      ████████████████░░░░  80.0%      ○ fixed          固定航向          目标航向: --             │ │   │
│  │  │  vy: -1.5 ~ 1.5 m/s   当前: 0.3       ○ target_point   朝向目标                                   │ │   │
│  │  │      ██████░░░░░░░░░░░░░░  20.0%      ○ manual         手动指定                                   │ │   │
│  │  │  vz:  0.0 ~ 2.0 m/s   当前: 0.0                                                                    │ │   │
│  │  │      ░░░░░░░░░░░░░░░░░░░░  0.0%       输出坐标系: 世界坐标系                                       │ │   │
│  │  │                                                                                                    │ │   │
│  │  └────────────────────────────────────────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                         运行统计                                                         │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                         │   │
│  │  运行时长                          控制周期统计                          状态统计                        │   │
│  │  ─────────────                    ─────────────                        ─────────────                    │   │
│  │  运行时长:    00:15:32            总控制周期:  46,600                   NORMAL:        98.5% (45,900)   │   │
│  │  总控制周期:  46,600              平均周期:    19.8 ms                  SOFT_DISABLED:  1.2% (560)      │   │
│  │  实际频率:    49.8 Hz             最大周期:    23.1 ms                  MPC_DEGRADED:   0.2% (93)       │   │
│  │                                   最小周期:    18.2 ms                  BACKUP_ACTIVE:  0.1% (47)       │   │
│  │                                   标准差:      1.2 ms                   STOPPING:       0.0% (0)        │   │
│  │                                                                        STOPPED:        0.0% (0)        │   │
│  │  性能指标                          事件统计                                                              │   │
│  │  ─────────────                    ─────────────                                                         │   │
│  │  MPC 成功率:      99.7%           备用切换次数:    3                                                    │   │
│  │  平均求解时间:    7.8 ms          安全限制次数:    12                                                   │   │
│  │  平均跟踪误差:    0.09 m          TF2 降级次数:    5                                                    │   │
│  │  最大跟踪误差:    0.28 m          Soft 禁用次数:   8                                                    │   │
│  │                                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                       警告/提醒 (Alerts)                                                 │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                         │   │
│  │  时间戳        级别   消息                                                                               │   │
│  │  ─────────────────────────────────────────────────────────────────────────────────────────────────────  │   │
│  │  14:32:15.123  ℹ️     系统启动完成，进入 NORMAL 状态                                                     │   │
│  │  14:32:18.456  ⚠️     TF2 查询超时，降级到 odom 积分 (已持续 120ms)                                      │   │
│  │  14:32:19.012  ✓      TF2 恢复正常，执行漂移校正 (漂移量: 0.02m)                                         │   │
│  │  14:33:05.789  ⚠️     MPC 求解时间 12.5ms，接近警告阈值 (15ms)                                           │   │
│  │  14:35:22.345  ⚠️     α_soft 降至 0.08，低于阈值 0.1，禁用 Soft Head                                     │   │
│  │  14:35:28.901  ✓      α_soft 恢复至 0.35，重新启用 Soft Head                                             │   │
│  │  14:40:15.567  ❌     Odom 超时 (250ms > 200ms)，进入 STOPPING 状态                                      │   │
│  │  14:40:16.234  ✓      Odom 恢复，系统恢复正常运行                                                        │   │
│  │                                                                                                         │   │
│  │  [清除日志]  [导出日志]  [筛选: 全部 ▼]                                                                  │   │
│  │                                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                       实时曲线 (最近 10 秒)                                              │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                         │   │
│  │  [MPC求解时间]  [跟踪误差]  [控制输出]  [一致性α]  [速度]                    ← 可切换显示的曲线          │   │
│  │                                                                                                         │   │
│  │  ┌─────────────────────────────────────────┐  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │  MPC 求解时间 (ms)                      │  │  跟踪误差 (m)                                       │  │   │
│  │  │                                         │  │                                                     │  │   │
│  │  │  15 ┤- - - - - - - - - - - - - - - - -  │  │  0.5 ┤                                              │  │   │
│  │  │     │              ╭─╮                  │  │      │                                              │  │   │
│  │  │  10 ┤─────────────╯  ╲─────────────    │  │  0.3 ┤─────────────────────────────────             │  │   │
│  │  │     │                                   │  │      │         ╭──────╮                            │  │   │
│  │  │   5 ┤                                   │  │  0.1 ┤────────╯      ╰────────────                 │  │   │
│  │  │     │                                   │  │      │                                              │  │   │
│  │  │   0 └───────────────────────────────    │  │    0 └──────────────────────────────────           │  │   │
│  │  │      -10s                        0s     │  │       -10s                              0s          │  │   │
│  │  │                                         │  │                                                     │  │   │
│  │  │  ─── 求解时间  - - - 警告阈值           │  │  ─── 横向误差  ─── 纵向误差  - - - 阈值            │  │   │
│  │  └─────────────────────────────────────────┘  └─────────────────────────────────────────────────────┘  │   │
│  │                                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 模块详细说明

### 3.1 顶部状态栏

始终显示的关键状态摘要，一眼可见系统整体健康状况。

| 信息项 | 说明 | 数据来源 |
|--------|------|----------|
| 状态 | 当前状态机状态，带颜色指示 | StateMachine.state |
| 控制器 | 当前使用的控制器 (MPC/Backup) | ControllerManager |
| 平台 | 平台类型 | config['system']['platform'] |
| ROS | ROS 环境是否可用 | ROS_AVAILABLE |
| ACADOS | ACADOS 求解器是否加载 | ACADOS_AVAILABLE |
| TF2 | TF2 是否可用 | TF2_AVAILABLE |
| IMU | IMU 数据是否可用 | TimeoutMonitor |
| 运行 | 系统运行时长 | 累计计时 |

### 3.2 系统信息面板

显示系统配置和运行环境的详细信息。

#### 运行环境
| 信息项 | 说明 |
|--------|------|
| ROS环境 | 是否检测到 ROS 并成功连接 |
| TF2可用 | TF2 坐标变换是否可用 |
| ACADOS | ACADOS 求解器是否加载成功 |
| IMU输入 | 是否有 IMU 数据输入 |

#### 控制策略
| 信息项 | 说明 |
|--------|------|
| 主控制器 | MPC (ACADOS) 或 MPC (Fallback) |
| 备用控制器 | Pure Pursuit / Stanley 等 |
| 当前使用 | 当前实际使用的控制器 |
| Soft Head | Soft 速度建议是否启用 |

#### 平台配置
| 信息项 | 说明 |
|--------|------|
| 平台类型 | differential/ackermann/omni/quadrotor |
| 控制频率 | 配置的控制频率 |
| MPC Horizon | 当前 MPC 预测步数 |
| 时间步长 | MPC dt |

#### 功能开关
| 信息项 | 说明 |
|--------|------|
| 自适应EKF | 自适应协方差调整是否启用 |
| 打滑检测 | 是否启用打滑检测 |
| 漂移校正 | TF2 恢复时的漂移校正 |
| 航向备选 | EKF θ 协方差过大时用 odom 航向 |

#### 坐标系配置
| 信息项 | 说明 |
|--------|------|
| 目标坐标系 | 轨迹所在坐标系 |
| 输出坐标系 | 控制命令坐标系 |
| TF2降级 | 是否正在使用 odom 积分降级 |
| 降级持续 | TF2 降级持续时间 |


### 3.3 系统状态面板

显示当前状态机状态，使用大字体和颜色背景突出显示。

| 状态 | 颜色 | 说明 |
|------|------|------|
| INIT | 灰色 | 初始化中，等待数据 |
| NORMAL | 绿色 | 正常运行，MPC 工作正常 |
| SOFT_DISABLED | 黄色 | Soft Head 禁用，仅使用 Hard 轨迹 |
| MPC_DEGRADED | 橙色 | MPC 降级，Horizon 降低 |
| BACKUP_ACTIVE | 橙红色 | 备用控制器激活 |
| STOPPING | 红色 | 正在平滑减速停车 |
| STOPPED | 深红色 | 已停车，速度为零 |

### 3.4 MPC 健康状态面板

监控 MPC 求解器的健康状况。

| 指标 | 阈值 | 说明 |
|------|------|------|
| 求解时间 | 警告: 8ms, 临界: 15ms | MPC 单次求解耗时 |
| KKT 残差 | 0.001 | 优化问题收敛质量 |
| 条件数 | 1e8 | 数值稳定性指标 |
| 连续警告次数 | 3 | 触发降级的连续警告次数 |
| Horizon | 正常: 20, 降级: 10 | MPC 预测步数 |

### 3.5 降级状态面板

显示 7 级状态机的所有状态，当前状态高亮显示。

每个状态显示：
- 状态编号和名称
- 状态说明
- 是否为当前状态

同时显示恢复计数器：
- Alpha 恢复计数 (从 SOFT_DISABLED 恢复)
- MPC 恢复计数 (从 MPC_DEGRADED/BACKUP_ACTIVE 恢复)

### 3.6 超时监控面板

监控各数据源的超时状态。

| 数据源 | 超时阈值 | 说明 |
|--------|----------|------|
| Odom | 200ms | 里程计数据 |
| Traj | 200ms | 轨迹数据 |
| IMU | 100ms | IMU 数据 |

显示内容：
- 当前数据年龄
- 超时阈值
- 进度条显示占比
- 宽限期状态

### 3.7 一致性分析面板

显示 Hard/Soft 一致性分析结果。

| 指标 | 阈值 | 权重 | 说明 |
|------|------|------|------|
| α_soft | 0.1 (禁用阈值) | - | 融合权重 |
| 曲率一致性 | 0.5 | 1.0 | κ_hard vs κ_soft |
| 速度方向一致性 | 0.8 | 1.5 | 速度向量夹角 |
| 时序平滑性 | 0.5 | 0.8 | 时间连续性 |

### 3.8 安全约束状态面板

显示安全约束配置和当前值。

#### 速度约束
| 参数 | 默认值 | 说明 |
|------|--------|------|
| v_max | 2.0 m/s | 最大速度 |
| v_min | 0.0 m/s | 最小速度 |
| omega_max | 2.0 rad/s | 最大角速度 |

#### 加速度约束
| 参数 | 默认值 | 说明 |
|------|--------|------|
| a_max | 1.5 m/s² | 最大水平加速度 |
| az_max | 1.0 m/s² | 最大垂直加速度 |
| alpha_max | 3.0 rad/s² | 最大角加速度 |

#### 低速保护
| 参数 | 默认值 | 说明 |
|------|--------|------|
| v_low_thresh | 0.1 m/s | 低速阈值 |
| omega_max_low | 1.0 rad/s | 低速时角速度限制 |

### 3.9 轨迹信息面板

显示当前轨迹的详细信息。

#### Hard 轨迹
| 信息项 | 说明 |
|--------|------|
| 轨迹点数 | 轨迹包含的点数 |
| 时间步长 | dt_sec |
| 总时长 | 轨迹覆盖的时间范围 |
| 坐标系 | 轨迹所在坐标系 |

#### Soft 建议
| 信息项 | 说明 |
|--------|------|
| 启用状态 | soft_enabled |
| 置信度 | confidence |
| 融合权重 | α_soft |

#### 轨迹模式
| 模式 | 说明 |
|------|------|
| MODE_TRACK | 正常跟踪模式 |
| MODE_STOP | 停车模式 |
| MODE_HOVER | 悬停模式 (无人机) |
| MODE_EMERGENCY | 紧急模式 |

### 3.10 跟踪误差面板

显示轨迹跟踪误差。

| 误差类型 | 阈值 | 说明 |
|----------|------|------|
| 横向误差 | 0.3m | 垂直于轨迹方向的误差 |
| 纵向误差 | 0.5m | 沿轨迹方向的误差 |
| 航向误差 | - | 航向角偏差 |
| 预测误差 | - | MPC 预测与实际的偏差 |

### 3.11 控制输出面板

显示当前控制命令。

| 输出项 | 说明 |
|--------|------|
| vx | 前向速度 |
| vy | 侧向速度 (全向车/无人机) |
| vz | 垂直速度 (无人机) |
| omega | 角速度 |
| 控制器 | 当前使用的控制器 |
| 过渡进度 | 控制器切换过渡进度 |
| 安全检查 | 安全检查是否通过 |

### 3.12 状态估计面板

显示 EKF 状态估计结果。

| 估计项 | 说明 |
|--------|------|
| 位置 (x, y, z) | 世界坐标系下的位置 |
| 航向 (θ) | 航向角 |
| 速度 (vx, vy, vz, omega) | 世界坐标系下的速度 |
| 协方差范数 | 估计不确定性 |
| 新息范数 | 观测与预测的偏差 |
| 打滑概率 | 检测到打滑的概率 |
| IMU 漂移 | 是否检测到 IMU 漂移 |
| IMU Bias | IMU 偏置估计值 |


### 3.13 平台专用面板

根据平台类型动态显示的专用面板。

#### 无人机姿态控制 (platform = quadrotor)

| 信息项 | 说明 |
|--------|------|
| Roll/Pitch/Yaw | 姿态命令 |
| Thrust | 归一化推力 |
| 角速度限制 | Roll/Pitch/Yaw Rate Max |
| 航向模式 | velocity/fixed/target/manual |
| 悬停 Yaw | 悬停时的目标航向 |
| Yaw 漂移补偿 | 是否启用漂移补偿 |
| 位置-姿态解耦 | 是否启用解耦模式 |

#### 全向车控制 (platform = omni)

| 信息项 | 说明 |
|--------|------|
| vx 约束 | vx_min ~ vx_max |
| vy 约束 | vy_min ~ vy_max |
| vz 约束 | 0 ~ vz_max |
| 航向模式 | follow_velocity/fixed/target_point/manual |
| 外部航向输入 | 是否启用外部航向指定 |

### 3.14 运行统计面板

显示系统运行的累计统计信息。

| 统计项 | 说明 |
|--------|------|
| 运行时长 | 系统启动后的运行时间 |
| 总控制周期 | 累计执行的控制周期数 |
| 实际频率 | 实际控制频率 |
| 周期统计 | 平均/最大/最小/标准差 |
| 状态统计 | 各状态占比和周期数 |
| MPC 成功率 | MPC 求解成功的比例 |
| 平均跟踪误差 | 历史平均跟踪误差 |
| 事件统计 | 备用切换/安全限制/TF2降级/Soft禁用次数 |

### 3.15 警告/提醒面板

显示带时间戳的事件日志。

#### 日志级别

| 级别 | 图标 | 颜色 | 说明 |
|------|------|------|------|
| 信息 | ℹ️ | 蓝色 | 正常事件通知 |
| 成功 | ✓ | 绿色 | 恢复/完成事件 |
| 警告 | ⚠️ | 黄色 | 需要关注的事件 |
| 错误 | ❌ | 红色 | 严重问题 |

#### 典型事件

| 事件 | 级别 | 说明 |
|------|------|------|
| 系统启动完成 | 信息 | 进入 NORMAL 状态 |
| TF2 降级 | 警告 | TF2 查询超时，降级到 odom 积分 |
| TF2 恢复 | 成功 | TF2 恢复正常，执行漂移校正 |
| MPC 求解时间警告 | 警告 | 求解时间接近阈值 |
| α_soft 过低 | 警告 | 禁用 Soft Head |
| α_soft 恢复 | 成功 | 重新启用 Soft Head |
| 数据超时 | 错误 | Odom/Traj/IMU 超时 |
| 数据恢复 | 成功 | 数据恢复正常 |
| 状态转换 | 信息 | 状态机状态变化 |
| 安全限制触发 | 警告 | 输出被安全监控器限制 |
| 控制器切换 | 信息 | MPC/Backup 切换 |

### 3.16 实时曲线面板

显示关键指标的实时曲线图。

#### 可选曲线

| 曲线 | 说明 |
|------|------|
| MPC 求解时间 | 显示求解时间和警告阈值线 |
| 跟踪误差 | 显示横向/纵向误差和阈值线 |
| 控制输出 | 显示 vx/vy/omega |
| 一致性 α | 显示 α_soft 和禁用阈值线 |
| 速度 | 显示估计速度 |

#### 曲线配置

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| 时间窗口 | 10 秒 | 显示最近 N 秒的数据 |
| 刷新频率 | 10 Hz | 曲线刷新频率 |
| 数据点数 | 500 | 最大保留的数据点数 |

---

## 4. 颜色方案

### 4.1 状态颜色

| 颜色 | RGB | 用途 |
|------|-----|------|
| 绿色 | #4CAF50 | NORMAL, 正常, 通过, 启用 |
| 黄色 | #FFC107 | SOFT_DISABLED, 警告 |
| 橙色 | #FF9800 | MPC_DEGRADED |
| 橙红色 | #FF5722 | BACKUP_ACTIVE |
| 红色 | #F44336 | STOPPING, 错误 |
| 深红色 | #B71C1C | STOPPED |
| 灰色 | #9E9E9E | INIT, 禁用, 未激活 |
| 蓝色 | #2196F3 | 信息提示 |

### 4.2 进度条颜色

| 占比 | 颜色 | 说明 |
|------|------|------|
| 0-50% | 绿色 | 安全范围 |
| 50-80% | 黄色 | 接近阈值 |
| 80-100% | 红色 | 接近或超过阈值 |

---

## 5. 交互功能

### 5.1 基本操作

| 操作 | 说明 |
|------|------|
| 曲线切换 | 点击标签切换显示的曲线 |
| 日志筛选 | 按级别筛选日志 |
| 日志清除 | 清除当前日志 |
| 日志导出 | 导出日志到文件 |
| 面板折叠 | 折叠/展开面板 |

### 5.2 快捷键

| 快捷键 | 功能 |
|--------|------|
| F5 | 刷新界面 |
| Ctrl+L | 清除日志 |
| Ctrl+S | 导出日志 |
| Esc | 关闭窗口 |

---

## 6. 技术实现

### 6.1 依赖

```
PyQt5>=5.15.0
matplotlib>=3.5.0
numpy>=1.20.0
```

### 6.2 数据接口

界面从 `ControllerManager` 获取 `DiagnosticsV2` 数据：

```python
class DashboardDataSource:
    def __init__(self, controller_manager: ControllerManager):
        self.manager = controller_manager
    
    def get_diagnostics(self) -> Dict[str, Any]:
        """获取诊断数据"""
        return self.manager._last_published_diagnostics
    
    def get_system_info(self) -> Dict[str, Any]:
        """获取系统信息"""
        return {
            'ros_available': ROS_AVAILABLE,
            'tf2_available': TF2_AVAILABLE,
            'acados_available': ACADOS_AVAILABLE,
            'platform': self.manager.config['system']['platform'],
            'ctrl_freq': self.manager.config['system']['ctrl_freq'],
            # ...
        }
```

### 6.3 刷新机制

```python
class DashboardWindow(QMainWindow):
    def __init__(self, data_source: DashboardDataSource):
        self.data_source = data_source
        self.refresh_timer = QTimer()
        self.refresh_timer.timeout.connect(self.refresh)
        self.refresh_timer.start(50)  # 20 Hz
    
    def refresh(self):
        """刷新界面数据"""
        diagnostics = self.data_source.get_diagnostics()
        if diagnostics:
            self.update_panels(diagnostics)
```

---

## 7. 文件结构

```
universal_controller/
└── dashboard/
    ├── __init__.py
    ├── main_window.py       # 主窗口
    ├── panels/
    │   ├── __init__.py
    │   ├── system_info.py   # 系统信息面板
    │   ├── state_panel.py   # 状态面板
    │   ├── mpc_health.py    # MPC 健康面板
    │   ├── degradation.py   # 降级状态面板
    │   ├── timeout.py       # 超时监控面板
    │   ├── consistency.py   # 一致性分析面板
    │   ├── safety.py        # 安全约束面板
    │   ├── trajectory.py    # 轨迹信息面板
    │   ├── tracking.py      # 跟踪误差面板
    │   ├── control.py       # 控制输出面板
    │   ├── estimator.py     # 状态估计面板
    │   ├── platform.py      # 平台专用面板
    │   ├── statistics.py    # 运行统计面板
    │   └── alerts.py        # 警告提醒面板
    ├── widgets/
    │   ├── __init__.py
    │   ├── progress_bar.py  # 自定义进度条
    │   ├── status_led.py    # 状态指示灯
    │   └── realtime_plot.py # 实时曲线
    ├── data_source.py       # 数据源接口
    └── styles.py            # 样式定义
```

---

## 8. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2024-12-21 | 初始版本，完整界面设计 |

