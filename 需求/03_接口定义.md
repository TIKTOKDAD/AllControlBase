# 通用控制器需求文档 - 接口定义

> 版本: v3.17

## 1. 输入接口

### 1.1 网络轨迹输入: `/nn/local_traj`

**消息类型**: `controller_msgs/LocalTrajectoryV4` (自定义)

```yaml
header:
  stamp: time
  frame_id: "world"

meta:
  dt_sec: float32
  num_points: uint32
  confidence: float32        # 网络置信度，范围 [0.0, 1.0]

# Hard Head: XYZ 轨迹点 (必选)
points_xyz:
  - x: float32
    y: float32
    z: float32

# Soft Head: 速度建议 (可选)
points_twist_enabled: bool   # 明确 Soft 是否启用
points_twist:
  - vx: float32
    vy: float32
    vz: float32
    wz: float32

mode: uint8
# MODE_TRACK = 0
# MODE_STOP = 1
# MODE_HOVER = 2
# MODE_EMERGENCY = 3
```

### 1.2 状态反馈输入: `/state/odom`

**消息类型**: `nav_msgs/Odometry` (ROS 标准)

**重要说明**:
- `pose` 是世界坐标系 (odom frame) 下的位姿
- `twist` 是**机体坐标系** (base_link frame) 下的速度
- EKF 内部会将 twist 转换到世界坐标系

### 1.3 IMU 输入: `/state/imu`

**消息类型**: `sensor_msgs/Imu` (ROS 标准)

### 1.4 外部航向输入: `/cmd/heading` (v3.14 新增)

**消息类型**: `std_msgs/Float32` (ROS 标准)

**说明**: 用于 HeadingMode.MANUAL 模式，外部指定目标航向角 (弧度)

---

## 2. 输出接口

### 2.1 控制命令输出: `/cmd_unified`

**消息类型**: `geometry_msgs/TwistStamped` (ROS 标准)

**坐标系定义**:
| 平台类型 | 坐标系 | 说明 |
|---------|--------|------|
| 差速/阿克曼车 | 机体坐标系 | `linear.x` = 前向速度, `angular.z` = 角速度 |
| 全向车 | 世界坐标系 | `linear.x`, `linear.y` = 平面速度, `angular.z` = 角速度 |
| 无人机 | 世界坐标系 | `linear.x`, `linear.y`, `linear.z` = 3D 速度, `angular.z` = yaw rate |

### 2.2 诊断输出: `/controller/diagnostics`

**消息类型**: `controller_msgs/DiagnosticsV2` (自定义)

```yaml
header:
  stamp: time

state: uint8
# STATE_INIT = 0
# STATE_NORMAL = 1
# STATE_SOFT_DISABLED = 2
# STATE_MPC_DEGRADED = 3
# STATE_BACKUP_ACTIVE = 4
# STATE_STOPPING = 5
# STATE_STOPPED = 6

mpc_success: bool
mpc_solve_time_ms: float32
backup_active: bool

mpc_health:
  kkt_residual: float32
  condition_number: float32
  consecutive_near_timeout: uint8
  degradation_warning: bool
  can_recover: bool

consistency:
  curvature: float32
  velocity_dir: float32
  temporal: float32
  alpha_soft: float32
  data_valid: bool

estimator_health:
  covariance_norm: float32
  innovation_norm: float32
  slip_probability: float32
  imu_drift_detected: bool
  imu_bias: float32[3]
  imu_available: bool

tracking:
  lateral_error: float32
  longitudinal_error: float32
  heading_error: float32
  prediction_error: float32

transform:
  tf2_available: bool
  fallback_duration_ms: float32
  accumulated_drift: float32

timeout:
  odom_timeout: bool
  traj_timeout: bool
  traj_grace_exceeded: bool
  imu_timeout: bool
  last_odom_age_ms: float32
  last_traj_age_ms: float32
  last_imu_age_ms: float32
  in_startup_grace: bool

cmd:
  vx: float32
  vy: float32
  vz: float32
  omega: float32
  frame_id: string

transition_progress: float32
```
