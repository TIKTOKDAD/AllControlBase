# 通用控制器需求文档 - 项目概述

> 版本: v3.17.6 | 日期: 2024-12-21

## 1. 目标

设计一个基于 MPC 的通用控制器，实现：
- **跨平台部署**：统一状态空间支持地面车辆和无人机
- **Hard/Soft 融合**：多维一致性门控，硬主干保证可用性，软建议提升平滑性
- **安全可靠**：热备控制器 + 渐进式降级，异常时安全停车
- **高实时性**：ACADOS 求解器，15ms 内完成优化
- **插件化架构**：核心模块可替换，便于扩展和维护

## 2. 系统边界

### 控制器负责：
- 接收网络输出的轨迹和速度建议
- 状态估计与滤波
- 融合 Hard/Soft 输出，生成最优控制命令
- 处理延迟、异常、降级

### 控制器不负责：
- 视觉/感知处理
- 全局规划/建图
- 平台特定执行（由适配层处理）

## 3. v3.17.6 修复内容

| 修复项 | 问题 | 修复 |
|--------|------|------|
| 诊断发布类型错误 | DiagnosticsV2 dataclass 不能直接被 ROS Publisher 发布 | 改用 to_ros_msg() 转换为字典，添加 _last_published_diagnostics 字段 |
| 测试用例配置传递错误 | test_mpc_horizon_dynamic_adjustment 传递完整 config 而非 config['mpc'] | 修正为 MPCController(config['mpc'], platform_config) |

## 4. v3.17.5 修复内容

| 修复项 | 问题 | 修复 |
|--------|------|------|
| DiagnosticsV2 未定义 | 诊断消息类型只有 YAML 结构，缺少 Python dataclass | 在数据类型定义中添加完整的 DiagnosticsV2 dataclass |
| 组件初始化顺序依赖 | coord_transformer 需要 state_estimator 先设置 | 改为延迟绑定，在所有组件注入后统一绑定 |
| ACADOS 依赖未声明 | 依赖导入中缺少 ACADOS/CasADi | 添加条件导入声明 |
| 诊断未实际发布 | _publish_diagnostics 代码被注释 | 实现完整的诊断消息构建和发布 |
| velocities 类型不一致 | Trajectory.velocities 可为 None，get_hard_velocities() 永不为 None | 添加 get_velocities() 统一接口 |
| 配置参数默认值分散 | 默认值分散在代码各处，参数说明不完整 | 添加 DEFAULT_CONFIG 常量和完整参数说明表 |

## 4. v3.17.4 修复内容

| 修复项 | 问题 | 修复 |
|--------|------|------|
| 依赖导入缺失 | 代码中使用 Header、Quaternion 等类型但未声明导入 | 在数据类型定义中添加完整的依赖导入声明 |
| 组件初始化缺失 | ControllerManager 组件都是 Optional 但无注入方法 | 添加 initialize_components() 方法 |
| theta_ref 未定义 | _solve_with_acados 中当 i>0 且所有条件不满足时变量未定义 | 在循环外初始化 theta_ref = state[6] |

## 5. v3.17 修复内容

| 修复项 | 问题 | 修复 |
|--------|------|------|
| SafetyMonitor health_metrics 丢失 | limited_cmd 创建时未复制 health_metrics | 完整复制所有字段 |
| temporal_valid 逻辑错误 | 只有 1 个数据时返回 data_valid=True | 修改为至少需要 2 个数据 |
| MPC 控制器框架代码 | compute() 返回全零 | 补充完整的 ACADOS 集成框架 |
| 缺少诊断消息发布 | ControllerManager 未发布诊断 | 添加 publish_diagnostics 方法 |
| safety_failed 状态转换延迟 | 状态转换在下一周期 | 在安全检查后立即更新状态机 |
| EKF 航向备选方案 | θ 估计不准时误差放大 | 添加 odom orientation 备选逻辑 |

## 6. 相关文档

- [02_系统架构.md](./02_系统架构.md) - 插件化架构与数据流
- [03_接口定义.md](./03_接口定义.md) - 输入输出接口
- [04_功能需求.md](./04_功能需求.md) - 功能需求列表
- [05_非功能需求.md](./05_非功能需求.md) - 性能与可靠性
- [06_数据类型定义.md](./06_数据类型定义.md) - 枚举与数据类
- [07_状态估计器.md](./07_状态估计器.md) - EKF 实现
- [08_一致性与健康监控.md](./08_一致性与健康监控.md) - 一致性分析
- [09_控制器实现.md](./09_控制器实现.md) - MPC/PurePursuit
- [10_状态机与安全.md](./10_状态机与安全.md) - 状态机与安全监控
- [11_配置参数.md](./11_配置参数.md) - 配置示例
- [12_测试计划.md](./12_测试计划.md) - 测试与术语表
