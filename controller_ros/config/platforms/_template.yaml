# _template.yaml
# 平台配置模板 - 用户可调参数
#
# =============================================================================
# 使用说明
# =============================================================================
#
# 1. 复制此文件并重命名为你的平台名称 (如 my_robot.yaml)
# 2. 根据平台类型删除不需要的参数区块:
#    - 差速车/阿克曼车: 删除 [全向车/四旋翼] 和 [四旋翼专用] 区块
#    - 全向车: 删除 [四旋翼专用] 和 [阿克曼车专用] 区块
#    - 四旋翼: 删除 [阿克曼车专用] 区块
# 3. 修改所有标记为 [必须修改] 的参数
# 4. 根据平台特性调整其他参数
#
# =============================================================================
# 配置原则
# =============================================================================
#
# 本文件包含所有用户可调参数，分为以下类别：
#
# [核心参数] - 必须根据平台硬件特性配置
#   - system: 平台类型、控制频率
#   - constraints: 速度、加速度限制
#   - transform: 坐标系配置
#
# [调优参数] - 可根据实际效果调整
#   - mpc: MPC 控制器权重和时域
#   - backup: 备份控制器增益
#   - safety: 安全阈值
#   - watchdog: 超时配置
#
# [高级参数] - 通常使用默认值即可
#   - consistency: 一致性检查阈值
#   - tracking: 跟踪质量评估阈值
#   - trajectory: 轨迹验证参数
#
# 不在本文件中定义的内容：
# - 物理常量 (如重力加速度、角度阈值) → core/constants.py
# - 算法内部参数 (如滤波器系数、EKF 噪声) → internal_params.yaml
#
# =============================================================================
# 配置加载顺序 (从低到高)
# =============================================================================
#
# 1. universal_controller/config/*.py  - Python 默认配置 (安全网)
# 2. base/controller_params.yaml       - ROS 层基础配置 (话题、时钟)
# 3. base/internal_params.yaml         - 内部实现参数 (用户不应修改)
# 4. 本 YAML 文件                       - 平台特定配置 (用户可调参数)
# 5. ROS 参数服务器                     - 运行时覆盖 (可选)
#
# =============================================================================
# 参数标记说明
# =============================================================================
#
# - [必须修改]: 必须根据实际平台修改
# - [建议调优]: 建议根据实际效果调整
# - [全向车/四旋翼]: 仅全向车和四旋翼平台需要
# - [四旋翼专用]: 仅四旋翼平台需要
# - [阿克曼车专用]: 仅阿克曼车平台需要
#


# =============================================================================
# 系统配置 [必须修改]
# =============================================================================
system:
  platform: "differential"        # 平台类型 [必须修改]: differential/omni/ackermann/quadrotor
  ctrl_freq: 50                   # 控制频率 (Hz) [1-1000]


# =============================================================================
# 运动约束 [必须修改]
#
# 这些参数直接影响控制器的安全性和性能
# 必须根据平台的实际硬件能力设置
# =============================================================================
constraints:
  # ---------------------------------------------------------------------------
  # 通用约束 (所有平台)
  # ---------------------------------------------------------------------------
  v_max: 1.5                      # 最大线速度 (m/s) [必须修改]
  v_min: 0.0                      # 最小线速度 (m/s)，负值允许倒车
  omega_max: 2.0                  # 最大角速度 (rad/s) [必须修改]
  omega_max_low: 1.0              # 低速时最大角速度 (rad/s)
  v_low_thresh: 0.1               # 低速阈值 (m/s)
  a_max: 1.5                      # 最大加速度 (m/s²) [必须修改]
  alpha_max: 3.0                  # 最大角加速度 (rad/s²) [必须修改]
  # ---------------------------------------------------------------------------
  # [全向车/四旋翼] 分轴速度约束 (差速车/阿克曼车删除以下行)
  # ---------------------------------------------------------------------------
  vx_max: 1.5                     # X 方向最大速度 (m/s)
  vx_min: -1.5                    # X 方向最小速度 (m/s)
  vy_max: 1.5                     # Y 方向最大速度 (m/s)
  vy_min: -1.5                    # Y 方向最小速度 (m/s)
  # ---------------------------------------------------------------------------
  # [四旋翼专用] 垂直运动约束 (地面车辆删除以下行)
  # ---------------------------------------------------------------------------
  vz_max: 2.0                     # Z 方向最大速度 (m/s)
  az_max: 1.0                     # 最大垂直加速度 (m/s²)


# =============================================================================
# 超时配置 (Watchdog) [建议调优]
#
# 超时检测时序:
#   t=0ms    收到轨迹
#   t=traj_timeout_ms 轨迹超时，进入宽限期
#   t=traj_timeout_ms + traj_grace_ms 宽限期结束，触发安全停止
#
# 注意: <=0 表示禁用该数据源的超时检测
# =============================================================================
watchdog:
  odom_timeout_ms: 500            # 里程计超时 (ms)，<=0 禁用
  traj_timeout_ms: 1000           # 轨迹超时 (ms)，<=0 禁用
  traj_grace_ms: 500              # 轨迹宽限期 (ms)
  imu_timeout_ms: -1              # IMU 超时 (ms)，<=0 禁用 [四旋翼必须启用，如 100]
  startup_grace_ms: 5000          # 启动宽限期 (ms)
  absolute_startup_timeout_ms: -1 # 绝对启动超时 (ms)，<=0 禁用


# =============================================================================
# 诊断配置
# =============================================================================
diagnostics:
  publish_rate: 10                # 诊断发布降频率 (每 N 次控制循环发布一次)


# =============================================================================
# MPC 配置 [建议调优]
#
# MPC 是主控制器，这些参数直接影响跟踪性能
# =============================================================================
mpc:
  # ---------------------------------------------------------------------------
  # 预测时域 [建议调优]
  # ---------------------------------------------------------------------------
  horizon: 20                     # MPC 预测时域 [1-100]，必须 < 轨迹点数
  horizon_degraded: 10            # 降级模式预测时域 [1-100]，必须 <= horizon
  dt: 0.1                         # 时间步长 (秒) [0.001-1.0]
  
  # ---------------------------------------------------------------------------
  # 代价函数权重 [建议调优]
  #
  # 调优指南:
  # - position: 增大提高位置精度，但可能导致控制抖动
  # - velocity: 增大提高速度跟踪精度
  # - heading: 增大提高航向精度，差速车建议较高值
  # - control_accel/alpha: 增大使控制更平滑，但响应变慢
  # ---------------------------------------------------------------------------
  weights:
    position: 10.0                # 位置跟踪权重
    velocity: 1.0                 # 速度跟踪权重
    heading: 5.0                  # 航向跟踪权重
    control_accel: 0.1            # 加速度控制权重
    control_alpha: 0.1            # 角加速度控制权重
  
  # ---------------------------------------------------------------------------
  # 健康监控 [建议调优]
  #
  # 这些阈值决定何时触发 MPC 降级
  # 如果 MPC 频繁降级，可以适当放宽阈值
  # ---------------------------------------------------------------------------
  health_monitor:
    time_warning_thresh_ms: 8     # 求解时间警告阈值 (ms)
    time_critical_thresh_ms: 15   # 求解时间临界阈值 (ms)，超过触发降级
    time_recovery_thresh_ms: 6    # 求解时间恢复阈值 (ms)
    consecutive_warning_limit: 3  # 连续警告次数限制
    consecutive_recovery_limit: 5 # 连续恢复次数限制
  
  # ---------------------------------------------------------------------------
  # Fallback 求解器
  # ---------------------------------------------------------------------------
  fallback:
    lookahead_steps: 3            # 前瞻步数


# =============================================================================
# 轨迹配置
# =============================================================================
trajectory:
  low_speed_thresh: 0.1           # 低速阈值 (m/s)，用于角速度计算和一致性检查
  min_points: 2                   # 最小轨迹点数
  max_points: 100                 # 最大轨迹点数，必须 > mpc.horizon
  max_point_distance: 10.0        # 相邻点最大距离 (m)
  default_dt_sec: 0.1             # 默认时间步长 (秒)


# =============================================================================
# 一致性检查配置
#
# 这些参数影响 alpha 值的计算，进而影响 soft/hard velocities 的混合比例
# 通常使用默认值即可
# =============================================================================
consistency:
  alpha_min: 0.1                  # α 最小值，低于此值禁用 soft 模式
  kappa_thresh: 0.5               # 曲率一致性阈值
  v_dir_thresh: 0.8               # 速度方向一致性阈值
  temporal_smooth_thresh: 0.5     # 时序平滑度阈值
  max_curvature: 10.0             # 曲率计算最大值限制 (1/m)
  temporal_window_size: 10        # 时序平滑度滑动窗口大小
  weights:
    kappa: 1.0                    # 曲率一致性权重
    velocity: 1.5                 # 速度方向一致性权重
    temporal: 0.8                 # 时序平滑度权重


# =============================================================================
# 跟踪质量评估配置 (Dashboard 显示用)
#
# 这些阈值仅影响 Dashboard 显示的评分，不影响控制器行为
# =============================================================================
tracking:
  lateral_thresh: 0.3             # 横向误差阈值 (m)
  longitudinal_thresh: 0.5        # 纵向误差阈值 (m)
  heading_thresh: 0.5             # 航向误差阈值 (rad, ~28.6°)


# =============================================================================
# 安全配置 [建议调优]
# =============================================================================
safety:
  emergency_decel: 3.0            # 紧急减速度 (m/s²)
  v_stop_thresh: 0.05             # 停车速度阈值 (m/s)
  stopping_timeout: 5.0           # 停车超时 (秒)
  # ---------------------------------------------------------------------------
  # [四旋翼专用] 垂直停车阈值 (地面车辆删除以下行)
  # ---------------------------------------------------------------------------
  vz_stop_thresh: 0.1             # 垂直停车速度阈值 (m/s)
  # ---------------------------------------------------------------------------
  # 状态机配置
  # ---------------------------------------------------------------------------
  state_machine:
    alpha_disable_thresh: 0.0     # α 禁用阈值，0 表示禁用 α 检查
    mpc_recovery_thresh: 5        # MPC 恢复计数阈值
    mpc_recovery_tolerance: 0     # MPC 恢复容错次数
    mpc_fail_window_size: 10      # MPC 失败检测滑动窗口大小
    mpc_fail_thresh: 3            # 窗口内失败次数阈值


# =============================================================================
# 备份控制器配置 (Pure Pursuit) [建议调优]
#
# MPC 失败时的备份控制策略
# =============================================================================
backup:
  # ---------------------------------------------------------------------------
  # 前瞻距离 [建议调优]
  # ---------------------------------------------------------------------------
  lookahead_dist: 1.0             # 前瞻距离 (m)
  min_lookahead: 0.5              # 最小前瞻距离 (m)
  max_lookahead: 3.0              # 最大前瞻距离 (m)
  lookahead_ratio: 0.5            # 前瞻比例，速度越快前瞻越远
  # ---------------------------------------------------------------------------
  # 控制增益 [建议调优]
  # ---------------------------------------------------------------------------
  kp_heading: 1.5                 # 航向增益
  # ---------------------------------------------------------------------------
  # [四旋翼专用] Z 方向增益 (地面车辆删除以下行)
  # ---------------------------------------------------------------------------
  kp_z: 1.0                       # Z 方向增益
  # ---------------------------------------------------------------------------
  # 控制参数
  # ---------------------------------------------------------------------------
  heading_error_thresh: 1.047     # 航向误差阈值 (rad, ~60°)
  max_curvature: 5.0              # 最大曲率限制 (1/m)
  default_speed_ratio: 0.5        # 无 soft 速度时的默认速度比例
  min_distance_thresh: 0.1        # 最小距离阈值 (m)
  # ---------------------------------------------------------------------------
  # [阿克曼车专用] 最小转向速度 (其他平台删除以下行)
  # ---------------------------------------------------------------------------
  min_turn_speed: 0.1             # 阿克曼车辆最小转向速度 (m/s)


# =============================================================================
# 坐标变换配置 [必须修改]
# =============================================================================
transform:
  source_frame: "base_link"       # 源坐标系 [必须修改]
  target_frame: "odom"            # 目标坐标系
  timeout_ms: 10                  # TF2 查询超时 (ms)


# =============================================================================
# cmd_vel 适配器配置 [必须修改]
#
# 速度/加速度限制统一从 constraints.* 读取，不在此处重复定义
# =============================================================================
cmd_vel_adapter:
  publish_rate: 20.0              # 命令发布频率 (Hz)
  cmd_timeout: 0.5                # 命令超时 (秒)
  enable_rate_limit: true         # 启用速度变化率限制
  joy_topic: "/joy_cmd_vel"       # 手柄输入话题
  mode_topic: "/visualizer/control_mode"  # 模式切换话题
  output_topic: "/cmd_vel"        # 输出话题 [必须修改]


# =============================================================================
# 话题配置 (可选覆盖)
#
# 默认值在 base/controller_params.yaml 中定义
# 只需覆盖与默认值不同的话题
# =============================================================================
# topics:
#   odom: "/odom"                   # 里程计输入话题
#   imu: ""                         # IMU 输入话题 (空字符串禁用)
#   trajectory: "/trajectory"       # 轨迹输入话题
#   cmd_unified: "/cmd_unified"     # 统一控制命令输出话题


# =============================================================================
# [四旋翼专用] 姿态控制配置
#
# 四旋翼平台必须取消注释以下配置
# 地面车辆 (differential/omni/ackermann) 应删除此区块
# =============================================================================
# attitude:
#   mass: 1.5                     # 质量 (kg) [必须修改]
#   roll_max: 0.5                 # 最大滚转角 (rad, ~30°)
#   pitch_max: 0.5                # 最大俯仰角 (rad, ~30°)
#   roll_rate_max: 3.0            # 最大滚转角速度 (rad/s)
#   pitch_rate_max: 3.0           # 最大俯仰角速度 (rad/s)
#   yaw_rate_max: 2.0             # 最大偏航角速度 (rad/s)
#   kp_vx: 0.5                    # X 方向速度增益
#   kp_vy: 0.5                    # Y 方向速度增益
#   kp_vz: 1.0                    # Z 方向速度增益
#   hover_yaw_compensation: true  # 悬停 yaw 补偿
#   hover_speed_thresh: 0.1       # 悬停水平速度阈值 (m/s)
#   hover_vz_thresh: 0.05         # 悬停垂直速度阈值 (m/s)
#   thrust_min: 0.1               # 最小推力
#   thrust_max: 2.0               # 最大推力
#   thrust_rate_max: 2.0          # 推力变化率限制 (每秒)
