# quadrotor.yaml
# 四旋翼平台配置
#
# 使用方法:
#   roslaunch controller_ros controller.launch platform:=quadrotor
#
# 四旋翼特性:
# - 3D 运动，可悬停
# - 需要 IMU 数据
# - 需要姿态控制
# - 适用于: 无人机
#

# =============================================================================
# 系统配置
# =============================================================================
system:
  ctrl_freq: 50                   # 控制频率 (Hz)
  platform: "quadrotor"           # 平台类型

# =============================================================================
# 运动约束 - 四旋翼 (3D 运动)
# =============================================================================
constraints:
  v_max: 3.0                      # 最大线速度 (m/s)
  v_min: 0.0                      # 最小线速度 (m/s)
  omega_max: 2.0                  # 最大角速度 (rad/s)
  omega_max_low: 1.0              # 低速时最大角速度 (rad/s)
  v_low_thresh: 0.1               # 低速阈值 (m/s)
  a_max: 2.0                      # 最大加速度 (m/s²)
  alpha_max: 3.0                  # 最大角加速度 (rad/s²)
  # 四旋翼特有约束
  vx_max: 3.0                     # X 方向最大速度 (m/s)
  vx_min: -3.0                    # X 方向最小速度 (m/s)
  vy_max: 3.0                     # Y 方向最大速度 (m/s)
  vy_min: -3.0                    # Y 方向最小速度 (m/s)
  vz_max: 2.0                     # Z 方向最大速度 (m/s)
  az_max: 1.0                     # 最大垂直加速度 (m/s²)

# =============================================================================
# 话题配置 - 四旋翼需要 IMU
#
# 注意: 只覆盖需要修改的话题，其他话题使用 base/controller_params.yaml 的默认值
# =============================================================================
topics:
  imu: "/imu"                     # 四旋翼需要 IMU 数据

# =============================================================================
# 超时配置 (Watchdog)
# =============================================================================
watchdog:
  odom_timeout_ms: 500            # 里程计超时 (ms)
  traj_timeout_ms: 1000           # 轨迹超时 (ms)
  traj_grace_ms: 500              # 轨迹宽限期 (ms)
  imu_timeout_ms: 100             # IMU 超时 (ms) - 四旋翼必须启用
  startup_grace_ms: 5000          # 启动宽限期 (ms)

# =============================================================================
# 诊断配置
# =============================================================================
diagnostics:
  publish_rate: 10                # 诊断发布降频率

# =============================================================================
# MPC 配置
# =============================================================================
mpc:
  horizon: 20                     # MPC 预测时域
  horizon_degraded: 10            # 降级模式预测时域
  dt: 0.1                         # 时间步长 (秒)
  
  weights:
    position: 10.0                # 位置跟踪权重
    velocity: 1.0                 # 速度跟踪权重
    heading: 5.0                  # 航向跟踪权重
    control_accel: 0.1            # 加速度控制权重
    control_alpha: 0.1            # 角加速度控制权重
  
  health_monitor:
    time_warning_thresh_ms: 8     # 求解时间警告阈值 (ms)
    time_critical_thresh_ms: 15   # 求解时间临界阈值 (ms)
    time_recovery_thresh_ms: 6    # 求解时间恢复阈值 (ms)
    consecutive_warning_limit: 3  # 连续警告次数限制
    consecutive_recovery_limit: 5 # 连续恢复次数限制
  
  fallback:
    lookahead_steps: 3            # 前瞻步数

# =============================================================================
# 轨迹配置
# =============================================================================
trajectory:
  low_speed_thresh: 0.1           # 低速阈值 (m/s)
  min_points: 2                   # 最小轨迹点数
  max_points: 100                 # 最大轨迹点数
  max_point_distance: 10.0        # 相邻点最大距离 (m)

# =============================================================================
# 一致性检查配置
# =============================================================================
consistency:
  alpha_min: 0.1                  # α 最小值
  kappa_thresh: 0.5               # 曲率一致性阈值
  v_dir_thresh: 0.8               # 速度方向一致性阈值
  temporal_smooth_thresh: 0.5     # 时序平滑度阈值
  max_curvature: 10.0             # 曲率计算最大值限制 (1/m)
  temporal_window_size: 10        # 时序平滑度滑动窗口大小
  weights:
    kappa: 1.0                    # 曲率一致性权重
    velocity: 1.5                 # 速度方向一致性权重
    temporal: 0.8                 # 时序平滑度权重

# =============================================================================
# 跟踪质量评估配置
# =============================================================================
tracking:
  lateral_thresh: 0.3             # 横向误差阈值 (m)
  longitudinal_thresh: 0.5        # 纵向误差阈值 (m)
  heading_thresh: 0.5             # 航向误差阈值 (rad)

# =============================================================================
# 安全配置
# =============================================================================
safety:
  emergency_decel: 3.0            # 紧急减速度 (m/s²)
  v_stop_thresh: 0.05             # 停车速度阈值 (m/s)
  vz_stop_thresh: 0.1             # 垂直停车速度阈值 (m/s)
  stopping_timeout: 5.0           # 停车超时 (秒)
  
  state_machine:
    alpha_disable_thresh: 0.0     # α 禁用阈值
    mpc_recovery_thresh: 5        # MPC 恢复计数阈值
    mpc_recovery_tolerance: 0     # MPC 恢复容错次数
    mpc_fail_window_size: 10      # MPC 失败检测滑动窗口大小
    mpc_fail_thresh: 3            # 窗口内失败次数阈值

# =============================================================================
# 备份控制器配置 (Pure Pursuit)
# =============================================================================
backup:
  lookahead_dist: 1.0             # 前瞻距离 (m)
  min_lookahead: 0.5              # 最小前瞻距离 (m)
  max_lookahead: 3.0              # 最大前瞻距离 (m)
  lookahead_ratio: 0.5            # 前瞻比例
  kp_heading: 1.5                 # 航向增益
  kp_z: 1.0                       # Z 方向增益
  heading_error_thresh: 1.047     # 航向误差阈值 (rad, ~60°)
  max_curvature: 5.0              # 最大曲率限制 (1/m)
  default_speed_ratio: 0.5        # 无 soft 速度时的默认速度比例
  min_distance_thresh: 0.1        # 最小距离阈值 (m)

# =============================================================================
# 坐标变换配置
# =============================================================================
transform:
  source_frame: "base_link"       # 源坐标系
  target_frame: "odom"            # 目标坐标系
  timeout_ms: 10                  # TF2 查询超时 (ms)
  buffer_warmup_timeout_sec: 2.0  # TF buffer 预热超时 (秒)
  buffer_warmup_interval_sec: 0.1 # TF buffer 预热检查间隔 (秒)

# =============================================================================
# 姿态控制配置 (四旋翼特有)
# =============================================================================
attitude:
  mass: 1.5                       # 质量 (kg)
  roll_max: 0.5                   # 最大滚转角 (rad, ~30°)
  pitch_max: 0.5                  # 最大俯仰角 (rad, ~30°)
  roll_rate_max: 3.0              # 最大滚转角速度 (rad/s)
  pitch_rate_max: 3.0             # 最大俯仰角速度 (rad/s)
  yaw_rate_max: 2.0               # 最大偏航角速度 (rad/s)
  kp_vx: 0.5                      # X 方向速度增益
  kp_vy: 0.5                      # Y 方向速度增益
  kp_vz: 1.0                      # Z 方向速度增益
  hover_yaw_compensation: true    # 悬停 yaw 补偿
  hover_speed_thresh: 0.1         # 悬停水平速度阈值 (m/s)
  hover_vz_thresh: 0.05           # 悬停垂直速度阈值 (m/s)
  thrust_min: 0.1                 # 最小推力
  thrust_max: 2.0                 # 最大推力
  thrust_rate_max: 2.0            # 推力变化率限制 (每秒)

# =============================================================================
# cmd_vel 适配器配置
# =============================================================================
cmd_vel_adapter:
  publish_rate: 50.0              # 命令发布频率 (Hz) - 四旋翼需要更高频率
  cmd_timeout: 0.2                # 命令超时 (秒) - 四旋翼需要更快响应
  enable_rate_limit: true         # 启用速度变化率限制
  joy_topic: "/joy_cmd_vel"       # 手柄输入话题
  mode_topic: "/visualizer/control_mode"  # 模式切换话题
  output_topic: "/cmd_vel"        # 输出话题
