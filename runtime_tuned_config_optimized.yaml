# ============================================================================
# 优化后的配置 - 基于运行时诊断分析
# 生成时间: 2025-12-30
# ============================================================================
#
# 主要修改:
#   1. 修复 omega_max 为 0 的问题 (关键!)
#   2. 增加 MPC velocity 权重改善纵向跟踪
#   3. 增加 position 权重改善横向跟踪
#   4. 调整轨迹超时容忍度
#   5. 优化状态机参数减少频繁切换
#
# ============================================================================

system:
  ctrl_freq: 20
  platform: differential
  gravity: 9.81
  long_pause_threshold: 0.5
  ekf_reset_threshold: 2.0

watchdog:
  odom_timeout_ms: 100
  traj_timeout_ms: 500      # 增加: 原303ms，轨迹延迟经常超过300ms
  traj_grace_ms: 250        # 增加: 原151ms
  imu_timeout_ms: -1
  startup_grace_ms: 5000

mpc:
  horizon: 4
  horizon_degraded: 3
  dt: 0.1
  weights:
    position: 15.0          # 增加: 原10.0，改善横向跟踪
    velocity: 8.0           # 增加: 原1.0，改善纵向跟踪 (诊断建议)
    heading: 5.0
    control_accel: 0.1      # 减小: 原0.2，允许更激进的加速
    control_alpha: 0.1      # 减小: 原0.2
  solver:
    nlp_max_iter: 50
    qp_solver: PARTIAL_CONDENSING_HPIPM
    integrator_type: ERK
    nlp_solver_type: SQP_RTI
  health_monitor:
    time_warning_thresh_ms: 20
    time_critical_thresh_ms: 40
    time_recovery_thresh_ms: 15
    condition_number_thresh: 100000000.0
    condition_number_recovery: 100000.0
    kkt_residual_thresh: 0.001
    consecutive_warning_limit: 10
    consecutive_recovery_limit: 5
    recovery_multiplier: 2.0
    consecutive_good_for_decay: 2
    timeout_decay_rate: 2
  fallback:
    lookahead_steps: 3
    heading_kp: 2.0         # 增加: 原1.5，改善转向响应
    max_curvature: 5.0
    min_distance_thresh: 0.1
    min_turn_speed: 0.1
    default_speed_ratio: 0.5

constraints:
  v_max: 0.5                # 略微增加: 原0.47，实测0.59
  v_min: -0.2
  omega_max: 1.0            # 关键修复! 原0.0，TurtleBot典型值1.0 rad/s
  omega_max_low: 0.5        # 关键修复! 原0.0，低速时的角速度限制
  v_low_thresh: 0.1
  a_max: 2.0                # 保守值: 原11.31太激进，实际使用2.0更平滑
  alpha_max: 1.5            # 增加: 原0.22太小
  az_max: 1.0
  vx_max: 0.5
  vx_min: -0.2
  vy_max: 0.0
  vy_min: 0.0
  vz_max: 2.0

safety:
  v_stop_thresh: 0.05
  vz_stop_thresh: 0.1
  stopping_timeout: 5.0
  emergency_decel: 3.0      # 减小: 原16.96太激进
  low_speed:
    threshold: 0.1
    omega_limit: 0.5        # 修复! 原0.0
  margins:
    velocity: 1.1
    acceleration: 1.5
  accel_filter_window: 3
  accel_filter_alpha: 0.3
  accel_filter_warmup_alpha: 0.5
  accel_filter_warmup_period: 3
  min_dt_for_accel: 0.001
  max_dt_for_accel: 1.0
  state_machine:
    alpha_disable_thresh: 0.0
    alpha_recovery_value: 0.0
    alpha_recovery_thresh: 5
    mpc_recovery_thresh: 5
    mpc_fail_window_size: 10
    mpc_fail_thresh: 5      # 增加: 原3，减少频繁切换
    mpc_fail_ratio_thresh: 0.6  # 增加: 原0.5
    mpc_recovery_history_min: 3
    mpc_recovery_recent_count: 5
    mpc_recovery_tolerance: 0
    mpc_recovery_success_ratio: 0.8

ekf:
  use_odom_orientation_fallback: true
  imu_motion_compensation: false
  theta_covariance_fallback_thresh: 0.5
  adaptive:
    base_slip_thresh: 2.0     # 固定值，不随底盘特性变化
    slip_velocity_factor: 0.5
    slip_covariance_scale: 10.0
    stationary_covariance_scale: 0.1
    stationary_thresh: 0.05
    slip_probability_k_factor: 5.0
    slip_history_window: 20
  max_tilt_angle: 1.047
  accel_freshness_thresh: 0.1
  min_velocity_for_jacobian: 0.01
  process_noise:
    position: 0.001
    velocity: 0.1
    orientation: 0.01
    angular_velocity: 0.1
    imu_bias: 0.0001
  measurement_noise:
    odom_position: 0.01
    odom_velocity: 0.1
    imu_accel: 0.5
    imu_gyro: 0.01
  anomaly_detection:
    drift_thresh: 0.1
    jump_thresh: 0.5
    covariance_explosion_thresh: 1000.0
    innovation_anomaly_thresh: 10.0
  covariance:
    min_eigenvalue: 1.0e-06
    initial_value: 0.1

consistency:
  kappa_thresh: 0.5
  v_dir_thresh: 0.8
  temporal_smooth_thresh: 0.5
  alpha_min: 0.1
  max_curvature: 10.0
  temporal_window_size: 10
  weights:
    kappa: 1.0
    velocity: 1.5
    temporal: 0.8

transform:
  target_frame: odom
  source_frame: base_link
  timeout_ms: 50
  fallback_duration_limit_ms: 500
  fallback_critical_limit_ms: 1000
  drift_estimation_enabled: false
  recovery_correction_enabled: true
  drift_rate: 0.01
  drift_velocity_factor: 0.1
  max_drift_dt: 0.5
  drift_correction_thresh: 0.01
  expected_source_frames:
    - base_link
    - base_footprint
    - base_link_0
    - ''
    - odom
  warn_unexpected_frame: true

transition:
  type: exponential
  tau: 0.1
  max_duration: 0.5
  completion_threshold: 0.95
  duration: 0.2

backup:
  lookahead_dist: 0.3
  min_lookahead: 0.18
  max_lookahead: 0.9
  lookahead_ratio: 0.5
  kp_z: 1.0
  kp_heading: 2.0           # 增加: 原1.5
  heading_mode: follow_velocity
  dt: 0.05
  heading_error_thresh: 1.047
  pure_pursuit_angle_thresh: 1.047
  heading_control_angle_thresh: 1.571
  max_curvature: 5.0
  min_turn_speed: 0.1
  default_speed_ratio: 0.5
  low_speed_transition_factor: 0.5
  curvature_speed_limit_thresh: 0.1
  min_distance_thresh: 0.1
  omega_rate_limit: null

trajectory:
  default_dt_sec: 0.1
  min_dt_sec: 0.01
  max_dt_sec: 1.0
  min_points: 2
  max_points: 100
  default_num_points: 8
  low_speed_thresh: 0.05    # 减小: 原0.1，诊断建议
  max_point_distance: 10.0
  min_confidence: 0.0
  max_confidence: 1.0
  default_confidence: 1.0
  default_frame_id: base_link
  output_frame_id: odom

tracking:
  lateral_thresh: 0.25      # 放宽: 原0.3，但实际误差经常超过
  longitudinal_thresh: 0.8  # 放宽: 原值太严格
  heading_thresh: 0.5
  prediction_thresh: 0.5
  weights:
    lateral: 0.4
    longitudinal: 0.4
    heading: 0.2
  rating:
    excellent: 90
    good: 70
    fair: 50

topics:
  odom: /odom
  imu: ''
  trajectory: /nn/local_trajectory
  emergency_stop: /controller/emergency_stop
  cmd_unified: /cmd_unified
  diagnostics: /controller/diagnostics
  state: /controller/state

tf:
  source_frame: base_link
  target_frame: odom
  timeout_ms: 50
  buffer_warmup_timeout_sec: 5.0
  buffer_warmup_interval_sec: 0.2
  expected_source_frames:
    - base_link
    - base_footprint
    - ''

cmd_vel_adapter:
  publish_rate: 20.0
  joy_timeout: 0.5
  max_linear: 0.5
  max_angular: 1.0          # 修复! 原0.0
  max_linear_accel: 2.0     # 修复! 原0.0
  max_angular_accel: 1.5    # 修复! 原0.0
  input_topic: /cmd_unified
  joy_topic: /joy_cmd_vel
  mode_topic: /visualizer/control_mode
  output_topic: /mobile_base/commands/velocity

diagnostics:
  topic: /controller/diagnostics
  cmd_topic: /cmd_unified
  publish_rate: 10
