# Universal Controller 项目结构

> 版本: v3.17.12 | 日期: 2024-12-22

## 目录结构

```
universal_controller/
├── __init__.py              # 包入口，导出主要类
├── main.py                  # 主程序入口
├── requirements.txt         # 依赖列表
├── README.md                # 项目说明
│
├── config/                  # 配置模块
│   ├── __init__.py
│   └── default_config.py    # 默认配置和平台配置
│
├── core/                    # 核心模块
│   ├── __init__.py
│   ├── data_types.py        # 数据类型定义
│   ├── enums.py             # 枚举定义
│   ├── interfaces.py        # 接口定义
│   └── ros_compat.py        # ROS 兼容层
│
├── estimator/               # 状态估计
│   ├── __init__.py
│   └── adaptive_ekf.py      # 自适应 EKF 状态估计器
│
├── tracker/                 # 轨迹跟踪
│   ├── __init__.py
│   ├── mpc_controller.py    # MPC 控制器
│   ├── pure_pursuit.py      # Pure Pursuit 备用控制器
│   └── attitude_controller.py # 无人机姿态控制器
│
├── consistency/             # 一致性检查
│   ├── __init__.py
│   └── weighted_analyzer.py # 加权一致性分析器
│
├── safety/                  # 安全模块
│   ├── __init__.py
│   ├── safety_monitor.py    # 安全监控器 (加速度滤波)
│   ├── state_machine.py     # 状态机 (MPC fail counter + decay)
│   └── timeout_monitor.py   # 超时监控器
│
├── health/                  # 健康监控
│   ├── __init__.py
│   └── mpc_health_monitor.py # MPC 健康监控器
│
├── transition/              # 平滑过渡
│   ├── __init__.py
│   └── smooth_transition.py # 平滑过渡控制器
│
├── transform/               # 坐标变换
│   ├── __init__.py
│   └── robust_transformer.py # 鲁棒坐标变换器
│
├── manager/                 # 控制器管理
│   ├── __init__.py
│   └── controller_manager.py # 控制器管理器
│
├── mock/                    # 模拟数据模块
│   ├── __init__.py
│   ├── ros_mock.py          # ROS 模拟类
│   ├── data_mock.py         # 模拟数据类型
│   ├── diagnostics_mock.py  # 模拟诊断数据生成
│   └── test_data_generator.py # 测试数据生成器
│
├── msg/                     # ROS 消息定义
│   ├── __init__.py
│   ├── CMakeLists.txt       # ROS 构建配置
│   ├── package.xml          # ROS 包配置
│   ├── DiagnosticsV2.msg    # 诊断消息
│   ├── LocalTrajectoryV4.msg # 轨迹消息
│   └── UnifiedCmd.msg       # 统一控制命令
│
├── dashboard/               # 可视化界面
│   ├── __init__.py
│   ├── main_window.py       # 主窗口
│   ├── data_source.py       # 数据源接口
│   ├── models.py            # 数据模型
│   ├── styles.py            # 样式定义
│   ├── run_dashboard.py     # 启动脚本
│   ├── panels/              # 面板组件 (14个)
│   │   ├── __init__.py
│   │   ├── system_info.py   # 系统信息
│   │   ├── state_panel.py   # 状态面板
│   │   ├── mpc_health.py    # MPC 健康
│   │   ├── degradation.py   # 降级状态
│   │   ├── timeout.py       # 超时监控
│   │   ├── consistency.py   # 一致性分析
│   │   ├── safety.py        # 安全约束
│   │   ├── trajectory.py    # 轨迹信息
│   │   ├── trajectory_view.py # 轨迹可视化
│   │   ├── tracking.py      # 跟踪误差
│   │   ├── control.py       # 控制输出
│   │   ├── estimator.py     # 状态估计
│   │   ├── statistics.py    # 运行统计
│   │   └── alerts.py        # 警告提醒
│   └── widgets/             # 自定义控件 (3个)
│       ├── __init__.py
│       ├── progress_bar.py  # 进度条
│       ├── status_led.py    # 状态指示灯
│       └── state_indicator.py # 状态指示器
│
├── visualization/           # 可视化扩展 (预留)
│
└── tests/                   # 测试模块
    ├── __init__.py
    ├── test_core.py         # 核心模块测试
    ├── test_components.py   # 组件测试
    ├── test_tf2_transform.py # TF2 变换测试
    ├── test_attitude_controller.py # 姿态控制器测试
    ├── test_integration.py  # 集成测试
    └── run_all_tests.py     # 运行所有测试
```

---

## 模块依赖关系

```
                    ┌─────────────────────────────────────┐
                    │         ControllerManager           │
                    │      (manager/controller_manager.py)│
                    └─────────────────────────────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ StateEstimator  │       │ TrajectoryTracker│       │ SafetyMonitor   │
│ (estimator/)    │       │ (tracker/)       │       │ (safety/)       │
└─────────────────┘       └─────────────────┘       └─────────────────┘
          │                           │                           │
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ ConsistencyChecker│     │ CoordTransformer │       │ StateMachine    │
│ (consistency/)  │       │ (transform/)     │       │ (safety/)       │
└─────────────────┘       └─────────────────┘       └─────────────────┘
          │                           │                           │
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ MPCHealthMonitor│       │ SmoothTransition │       │ TimeoutMonitor  │
│ (health/)       │       │ (transition/)    │       │ (safety/)       │
└─────────────────┘       └─────────────────┘       └─────────────────┘
          │                           │                           │
          └───────────────────────────┼───────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │           Core Module               │
                    │  (core/data_types, enums, interfaces)│
                    └─────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │         Config Module               │
                    │    (config/default_config.py)       │
                    └─────────────────────────────────────┘
```

---

## 文件详细说明

### 核心模块 (core/)

| 文件 | 功能 |
|------|------|
| `enums.py` | 定义所有枚举类型 (ControllerState, PlatformType, DegradationLevel 等) |
| `data_types.py` | 定义所有数据类型 (dataclass): Pose3D, Twist3D, TrajectoryPoint 等 |
| `interfaces.py` | 定义所有抽象接口 (ABC): IStateEstimator, ITrajectoryTracker 等 |
| `ros_compat.py` | ROS 兼容层，支持 ROS 和独立模式，完整四元数归一化 |

### 状态估计 (estimator/)

| 文件 | 功能 |
|------|------|
| `adaptive_ekf.py` | 自适应 EKF 实现，11 维状态向量，Joseph 形式更新 |

### 轨迹跟踪 (tracker/)

| 文件 | 功能 |
|------|------|
| `mpc_controller.py` | MPC 控制器，支持 ACADOS 和 fallback 模式 |
| `pure_pursuit.py` | Pure Pursuit 备用控制器，支持 3D 跟踪 |
| `attitude_controller.py` | 四旋翼姿态控制器，悬停检测带滞回 |

### 一致性检查 (consistency/)

| 文件 | 功能 |
|------|------|
| `weighted_analyzer.py` | 加权几何平均一致性分析，支持曲率/速度/时序检查 |

### 安全模块 (safety/)

| 文件 | 功能 |
|------|------|
| `safety_monitor.py` | 速度/加速度安全检查，加速度滤波 (α=0.3) |
| `state_machine.py` | 7 级状态机，MPC fail counter 带衰减机制 |
| `timeout_monitor.py` | 超时监控，使用单一 monotonic 时钟 |

### 健康监控 (health/)

| 文件 | 功能 |
|------|------|
| `mpc_health_monitor.py` | MPC 求解器健康监控，时间/条件数/KKT 残差检查 |

### 坐标变换 (transform/)

| 文件 | 功能 |
|------|------|
| `robust_transformer.py` | TF2 集成 + 降级策略，支持漂移估计 |

### 平滑过渡 (transition/)

| 文件 | 功能 |
|------|------|
| `smooth_transition.py` | 指数/线性平滑过渡，支持完成度检测 |

### 控制器管理 (manager/)

| 文件 | 功能 |
|------|------|
| `controller_manager.py` | 主控制循环，组件协调，诊断回调 |

### 配置 (config/)

| 文件 | 功能 |
|------|------|
| `default_config.py` | 默认配置和平台配置 (differential/ackermann/omni/quadrotor) |

### Mock 模块 (mock/)

| 文件 | 功能 |
|------|------|
| `ros_mock.py` | ROS 模拟实现 (Publisher, Subscriber, Node) |
| `data_mock.py` | 数据类型模拟 |
| `diagnostics_mock.py` | 诊断数据生成 |
| `test_data_generator.py` | 测试数据生成 (轨迹、里程计) |

### Dashboard (dashboard/)

| 文件 | 功能 |
|------|------|
| `main_window.py` | 主窗口，面板布局管理 |
| `data_source.py` | 数据源接口，支持实时/模拟数据 |
| `models.py` | 数据模型定义 |
| `styles.py` | 样式定义 (颜色、字体) |
| `panels/*.py` | 14 个面板组件 |
| `widgets/*.py` | 3 个自定义控件 |

### 测试 (tests/)

| 文件 | 功能 |
|------|------|
| `test_core.py` | 核心模块测试 |
| `test_components.py` | 组件单元测试 |
| `test_tf2_transform.py` | TF2 变换测试 |
| `test_attitude_controller.py` | 姿态控制器测试 |
| `test_integration.py` | 集成测试 |

---

## 代码统计

| 类别 | 文件数 | 说明 |
|------|--------|------|
| 核心模块 | 5 | enums, data_types, interfaces, ros_compat, __init__ |
| 状态估计 | 2 | adaptive_ekf, __init__ |
| 轨迹跟踪 | 4 | mpc_controller, pure_pursuit, attitude_controller, __init__ |
| 一致性检查 | 2 | weighted_analyzer, __init__ |
| 安全模块 | 4 | safety_monitor, state_machine, timeout_monitor, __init__ |
| 健康监控 | 2 | mpc_health_monitor, __init__ |
| 坐标变换 | 2 | robust_transformer, __init__ |
| 平滑过渡 | 2 | smooth_transition, __init__ |
| 控制器管理 | 2 | controller_manager, __init__ |
| 配置 | 2 | default_config, __init__ |
| Mock 模块 | 5 | ros_mock, data_mock, diagnostics_mock, test_data_generator, __init__ |
| Dashboard | 22 | main_window, data_source, models, styles, run_dashboard, 14 panels, 3 widgets |
| 消息定义 | 6 | 3 msg 文件, CMakeLists, package.xml, __init__ |
| 测试 | 7 | 5 测试文件, run_all_tests, __init__ |
| 根目录 | 4 | __init__, main, README, requirements |
| **总计** | **65** | 不含 __pycache__ |

---

## 接口继承关系

```
IStateEstimator (ABC)
    └── AdaptiveEKFEstimator

ITrajectoryTracker (ABC)
    ├── MPCController
    └── PurePursuitController

IConsistencyChecker (ABC)
    └── WeightedConsistencyAnalyzer

ISafetyMonitor (ABC)
    └── BasicSafetyMonitor

ISmoothTransition (ABC)
    ├── ExponentialSmoothTransition
    └── LinearSmoothTransition

ICoordinateTransformer (ABC)
    └── RobustCoordinateTransformer

IAttitudeController (ABC)
    └── QuadrotorAttitudeController
```

---

## 数据流图

```
输入层:
  ┌─────────┐   ┌─────────────┐   ┌─────────┐
  │  Odom   │   │  Trajectory │   │   IMU   │
  └────┬────┘   └──────┬──────┘   └────┬────┘
       │               │               │
       ▼               ▼               ▼
处理层:
  ┌─────────────────────────────────────────┐
  │     TimeoutMonitor (monotonic clock)    │
  └─────────────────────────────────────────┘
       │               │               │
       ▼               ▼               ▼
  ┌─────────────────────────────────────────┐
  │         AdaptiveEKFEstimator            │
  │  predict() → update_odom() → update_imu()│
  │         (Joseph form update)            │
  └─────────────────────────────────────────┘
       │               │
       ▼               ▼
  ┌──────────────┐  ┌──────────────────────┐
  │ Consistency  │  │ CoordTransformer     │
  │   Analyzer   │  │ (TF2 + Fallback)     │
  └──────────────┘  └──────────────────────┘
       │               │
       ▼               ▼
  ┌─────────────────────────────────────────┐
  │    MPCController / PurePursuitController │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │           MPCHealthMonitor              │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │   StateMachine (fail counter + decay)   │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │   SafetyMonitor (accel filtering)       │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │          SmoothTransition               │
  └─────────────────────────────────────────┘
       │
       ▼
输出层:
  ┌─────────────┐   ┌─────────────────────┐
  │ ControlOutput│   │   DiagnosticsV2    │
  └─────────────┘   └─────────────────────┘
```

---

## 关键技术特性

| 特性 | 实现位置 | 说明 |
|------|----------|------|
| 单一时钟源 | 全局 | `time.monotonic()` 统一使用 |
| 加速度滤波 | safety_monitor.py | 一阶低通滤波 α=0.3 |
| MPC fail counter | state_machine.py | 带衰减机制，防止抖动 |
| 悬停检测 | attitude_controller.py | 滞回逻辑，防止频繁切换 |
| 四元数归一化 | ros_compat.py | 完整归一化，处理零向量 |
| Joseph 形式更新 | adaptive_ekf.py | 数值稳定的协方差更新 |
