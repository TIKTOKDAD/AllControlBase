# Universal Controller 项目结构

> 版本: v3.17.11 | 日期: 2024-12-21

## 目录结构

```
universal_controller/
├── __init__.py              # 包入口，导出主要类
├── main.py                  # 主程序入口
├── requirements.txt         # 依赖列表
├── README.md                # 项目说明
│
├── config/                  # 配置模块
│   ├── __init__.py
│   └── default_config.py    # 默认配置和平台配置
│
├── core/                    # 核心模块
│   ├── __init__.py
│   ├── data_types.py        # 数据类型定义
│   ├── enums.py             # 枚举定义
│   ├── interfaces.py        # 接口定义
│   └── ros_compat.py        # ROS 兼容层
│
├── estimator/               # 状态估计
│   ├── __init__.py
│   └── adaptive_ekf.py      # 自适应 EKF 状态估计器
│
├── tracker/                 # 轨迹跟踪
│   ├── __init__.py
│   ├── mpc_controller.py    # MPC 控制器
│   ├── pure_pursuit.py      # Pure Pursuit 备用控制器
│   └── attitude_controller.py # 无人机姿态控制器
│
├── consistency/             # 一致性检查
│   ├── __init__.py
│   └── weighted_analyzer.py # 加权一致性分析器
│
├── safety/                  # 安全模块
│   ├── __init__.py
│   ├── safety_monitor.py    # 安全监控器
│   ├── state_machine.py     # 状态机
│   └── timeout_monitor.py   # 超时监控器
│
├── health/                  # 健康监控
│   ├── __init__.py
│   └── mpc_health_monitor.py # MPC 健康监控器
│
├── transition/              # 平滑过渡
│   ├── __init__.py
│   └── smooth_transition.py # 平滑过渡控制器
│
├── transform/               # 坐标变换
│   ├── __init__.py
│   └── robust_transformer.py # 鲁棒坐标变换器
│
├── manager/                 # 控制器管理
│   ├── __init__.py
│   └── controller_manager.py # 控制器管理器
│
├── mock/                    # 模拟数据模块
│   ├── __init__.py
│   ├── ros_mock.py          # ROS 模拟类
│   ├── data_mock.py         # 模拟数据类型
│   ├── diagnostics_mock.py  # 模拟诊断数据生成
│   └── test_data_generator.py # 测试数据生成器
│
├── msg/                     # ROS 消息定义
│   ├── DiagnosticsV2.msg    # 诊断消息
│   ├── LocalTrajectoryV4.msg # 轨迹消息
│   └── UnifiedCmd.msg       # 统一控制命令
│
├── dashboard/               # 可视化界面
│   ├── __init__.py
│   ├── main_window.py       # 主窗口
│   ├── data_source.py       # 数据源接口
│   ├── styles.py            # 样式定义
│   ├── run_dashboard.py     # 启动脚本
│   ├── panels/              # 面板组件
│   │   ├── __init__.py
│   │   ├── system_info.py   # 系统信息
│   │   ├── state_panel.py   # 状态面板
│   │   ├── mpc_health.py    # MPC 健康
│   │   ├── degradation.py   # 降级状态
│   │   ├── timeout.py       # 超时监控
│   │   ├── consistency.py   # 一致性分析
│   │   ├── safety.py        # 安全约束
│   │   ├── trajectory.py    # 轨迹信息
│   │   ├── trajectory_view.py # 轨迹可视化
│   │   ├── tracking.py      # 跟踪误差
│   │   ├── control.py       # 控制输出
│   │   ├── estimator.py     # 状态估计
│   │   ├── statistics.py    # 运行统计
│   │   └── alerts.py        # 警告提醒
│   └── widgets/             # 自定义控件
│       ├── __init__.py
│       ├── progress_bar.py  # 进度条
│       ├── status_led.py    # 状态指示灯
│       └── state_indicator.py # 状态指示器
│
└── tests/                   # 测试模块
    ├── __init__.py
    ├── test_core.py         # 核心模块测试
    ├── test_components.py   # 组件测试
    ├── test_tf2_transform.py # TF2 变换测试
    ├── test_attitude_controller.py # 姿态控制器测试
    ├── test_integration.py  # 集成测试
    └── run_all_tests.py     # 运行所有测试
```

---

## 模块依赖关系

```
                    ┌─────────────────────────────────────┐
                    │         ControllerManager           │
                    │      (manager/controller_manager.py)│
                    └─────────────────────────────────────┘
                                      │
          ┌───────────────────────────┼───────────────────────────┐
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ StateEstimator  │       │ TrajectoryTracker│       │ SafetyMonitor   │
│ (estimator/)    │       │ (tracker/)       │       │ (safety/)       │
└─────────────────┘       └─────────────────┘       └─────────────────┘
          │                           │                           │
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ ConsistencyChecker│     │ CoordTransformer │       │ StateMachine    │
│ (consistency/)  │       │ (transform/)     │       │ (safety/)       │
└─────────────────┘       └─────────────────┘       └─────────────────┘
          │                           │                           │
          │                           │                           │
          ▼                           ▼                           ▼
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│ MPCHealthMonitor│       │ SmoothTransition │       │ TimeoutMonitor  │
│ (health/)       │       │ (transition/)    │       │ (safety/)       │
└─────────────────┘       └─────────────────┘       └─────────────────┘
          │                           │                           │
          └───────────────────────────┼───────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │           Core Module               │
                    │  (core/data_types, enums, interfaces)│
                    └─────────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────────┐
                    │         Config Module               │
                    │    (config/default_config.py)       │
                    └─────────────────────────────────────┘
```

---

## 文件详细说明

### 核心模块 (core/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `enums.py` | ~55 | 定义所有枚举类型 |
| `data_types.py` | ~320 | 定义所有数据类型 (dataclass) |
| `interfaces.py` | ~130 | 定义所有抽象接口 |
| `ros_compat.py` | ~195 | ROS 兼容层，支持 ROS 和独立模式 |

### 状态估计 (estimator/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `adaptive_ekf.py` | ~320 | 自适应 EKF 实现，11 维状态向量 |

### 轨迹跟踪 (tracker/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `mpc_controller.py` | ~320 | MPC 控制器，支持 ACADOS 和 fallback |
| `pure_pursuit.py` | ~280 | Pure Pursuit 备用控制器 |
| `attitude_controller.py` | ~350 | 四旋翼姿态控制器 |

### 一致性检查 (consistency/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `weighted_analyzer.py` | ~130 | 加权几何平均一致性分析 |

### 安全模块 (safety/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `safety_monitor.py` | ~110 | 速度/加速度安全检查 |
| `state_machine.py` | ~150 | 7 级状态机 |
| `timeout_monitor.py` | ~100 | 超时监控 |

### 健康监控 (health/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `mpc_health_monitor.py` | ~80 | MPC 求解器健康监控 |

### 坐标变换 (transform/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `robust_transformer.py` | ~280 | TF2 集成 + 降级策略 |

### 平滑过渡 (transition/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `smooth_transition.py` | ~100 | 指数/线性平滑过渡 |

### 控制器管理 (manager/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `controller_manager.py` | ~450 | 主控制循环，组件协调 |

### 配置 (config/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `default_config.py` | ~180 | 默认配置和平台配置 |

### Mock 模块 (mock/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `ros_mock.py` | ~280 | ROS 模拟实现 |
| `data_mock.py` | ~100 | 数据类型模拟 |
| `diagnostics_mock.py` | ~80 | 诊断数据生成 |
| `test_data_generator.py` | ~180 | 测试数据生成 |

### Dashboard (dashboard/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `main_window.py` | ~250 | 主窗口 |
| `data_source.py` | ~150 | 数据源接口 |
| `styles.py` | ~100 | 样式定义 |
| `panels/*.py` | ~1500 | 14 个面板组件 |
| `widgets/*.py` | ~200 | 3 个自定义控件 |

### 测试 (tests/)

| 文件 | 行数 | 功能 |
|------|------|------|
| `test_core.py` | ~150 | 核心模块测试 |
| `test_components.py` | ~200 | 组件单元测试 |
| `test_tf2_transform.py` | ~150 | TF2 变换测试 |
| `test_attitude_controller.py` | ~200 | 姿态控制器测试 |
| `test_integration.py` | ~250 | 集成测试 |

---

## 代码统计

| 类别 | 文件数 | 代码行数 (约) |
|------|--------|---------------|
| 核心模块 | 4 | 700 |
| 状态估计 | 1 | 320 |
| 轨迹跟踪 | 3 | 950 |
| 一致性检查 | 1 | 130 |
| 安全模块 | 3 | 360 |
| 健康监控 | 1 | 80 |
| 坐标变换 | 1 | 280 |
| 平滑过渡 | 1 | 100 |
| 控制器管理 | 1 | 450 |
| 配置 | 1 | 180 |
| Mock 模块 | 4 | 640 |
| Dashboard | 20 | 2200 |
| 测试 | 6 | 950 |
| **总计** | **47** | **~7340** |

---

## 接口继承关系

```
IStateEstimator (ABC)
    └── AdaptiveEKFEstimator

ITrajectoryTracker (ABC)
    ├── MPCController
    └── PurePursuitController

IConsistencyChecker (ABC)
    └── WeightedConsistencyAnalyzer

ISafetyMonitor (ABC)
    └── BasicSafetyMonitor

ISmoothTransition (ABC)
    ├── ExponentialSmoothTransition
    └── LinearSmoothTransition

ICoordinateTransformer (ABC)
    └── RobustCoordinateTransformer

IAttitudeController (ABC)
    └── QuadrotorAttitudeController
```

---

## 数据流图

```
输入层:
  ┌─────────┐   ┌─────────────┐   ┌─────────┐
  │  Odom   │   │  Trajectory │   │   IMU   │
  └────┬────┘   └──────┬──────┘   └────┬────┘
       │               │               │
       ▼               ▼               ▼
处理层:
  ┌─────────────────────────────────────────┐
  │           TimeoutMonitor                │
  └─────────────────────────────────────────┘
       │               │               │
       ▼               ▼               ▼
  ┌─────────────────────────────────────────┐
  │         AdaptiveEKFEstimator            │
  │  predict() → update_odom() → update_imu()│
  └─────────────────────────────────────────┘
       │               │
       ▼               ▼
  ┌──────────────┐  ┌──────────────────────┐
  │ Consistency  │  │ CoordTransformer     │
  │   Analyzer   │  │ (TF2 + Fallback)     │
  └──────────────┘  └──────────────────────┘
       │               │
       ▼               ▼
  ┌─────────────────────────────────────────┐
  │    MPCController / PurePursuitController │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │           MPCHealthMonitor              │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │             StateMachine                │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │           SafetyMonitor                 │
  └─────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────┐
  │          SmoothTransition               │
  └─────────────────────────────────────────┘
       │
       ▼
输出层:
  ┌─────────────┐   ┌─────────────────────┐
  │ ControlOutput│   │   DiagnosticsV2    │
  └─────────────┘   └─────────────────────┘
```
