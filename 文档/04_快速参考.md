# Universal Controller 快速参考

## 安装

```bash
pip install numpy scipy PyYAML
pip install PyQt5 matplotlib  # Dashboard (可选)
```

## 基本使用

```python
from universal_controller import ControllerManager, DEFAULT_CONFIG
from universal_controller.mock.test_data_generator import create_test_trajectory, create_test_odom

config = DEFAULT_CONFIG.copy()
config['system']['platform'] = 'differential'

manager = ControllerManager(config)
manager.initialize_default_components()

odom = create_test_odom(x=0, y=0, theta=0, vx=0.5)
trajectory = create_test_trajectory(trajectory_type='sine')

cmd = manager.update(odom, trajectory)
print(f"vx={cmd.vx:.2f}, omega={cmd.omega:.2f}")

manager.shutdown()
```

## 平台类型

| 平台 | 配置值 | 输出 | 坐标系 |
|------|--------|------|--------|
| 差速车 | `differential` | vx, omega | base_link |
| 阿克曼车 | `ackermann` | vx, omega | base_link |
| 全向车 | `omni` | vx, vy, omega | world |
| 四旋翼 | `quadrotor` | vx, vy, vz, omega | world |

## 控制器状态

| 状态 | 值 | 说明 |
|------|-----|------|
| INIT | 0 | 初始化 |
| NORMAL | 1 | 正常运行 |
| SOFT_DISABLED | 2 | Soft 禁用 |
| MPC_DEGRADED | 3 | MPC 降级 |
| BACKUP_ACTIVE | 4 | 备用控制器 |
| STOPPING | 5 | 停车中 |
| STOPPED | 6 | 已停车 |

## 关键配置

```python
config['system']['ctrl_freq'] = 50      # 控制频率
config['mpc']['horizon'] = 20           # MPC horizon
config['constraints']['v_max'] = 2.0    # 最大速度
config['constraints']['omega_max'] = 2.0 # 最大角速度
config['watchdog']['odom_timeout_ms'] = 200  # Odom 超时
config['consistency']['alpha_min'] = 0.1     # α 最小值
```

## 运行命令

```bash
python -m universal_controller.main              # 示例
python -m universal_controller.dashboard.run_dashboard  # Dashboard
python universal_controller/tests/run_all_tests.py      # 测试
```

## 诊断回调

```python
def on_diagnostics(diag):
    print(f"State: {diag['state']}")
    print(f"Alpha: {diag['consistency']['alpha_soft']}")

manager.set_diagnostics_callback(on_diagnostics)
```

## 无人机姿态

```python
config['system']['platform'] = 'quadrotor'
manager = ControllerManager(config)
manager.initialize_default_components()

cmd = manager.update(odom, trajectory)
attitude = manager.compute_attitude_command(cmd, state, yaw_mode='velocity')
# attitude.roll, attitude.pitch, attitude.yaw, attitude.thrust
```
