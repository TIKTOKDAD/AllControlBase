# Universal Controller 快速参考

> 版本: v3.17.12 | 日期: 2024-12-22

## 安装

```bash
pip install numpy scipy PyYAML
pip install PyQt5 matplotlib  # Dashboard (可选)
```

## 基本使用

```python
from universal_controller import ControllerManager, DEFAULT_CONFIG
from universal_controller.mock.test_data_generator import create_test_trajectory, create_test_odom

config = DEFAULT_CONFIG.copy()
config['system']['platform'] = 'differential'

manager = ControllerManager(config)
manager.initialize_default_components()

odom = create_test_odom(x=0, y=0, theta=0, vx=0.5)
trajectory = create_test_trajectory(trajectory_type='sine')

cmd = manager.update(odom, trajectory)
print(f"vx={cmd.vx:.2f}, omega={cmd.omega:.2f}")

manager.shutdown()
```

---

## 平台类型

| 平台 | 配置值 | 输出 | 坐标系 |
|------|--------|------|--------|
| 差速车 | `differential` | vx, omega | base_link |
| 阿克曼车 | `ackermann` | vx, omega | base_link |
| 全向车 | `omni` | vx, vy, omega | world |
| 四旋翼 | `quadrotor` | vx, vy, vz, omega | world |

---

## 控制器状态 (ControllerState)

| 状态 | 值 | 说明 |
|------|-----|------|
| INIT | 0 | 初始化 |
| NORMAL | 1 | 正常运行 |
| SOFT_DISABLED | 2 | Soft 禁用 (α < 阈值) |
| MPC_DEGRADED | 3 | MPC 降级 |
| BACKUP_ACTIVE | 4 | 备用控制器激活 |
| STOPPING | 5 | 停车中 |
| STOPPED | 6 | 已停车 |

---

## 关键配置参数

### 系统配置
```python
config['system']['ctrl_freq'] = 50      # 控制频率 (Hz)
config['system']['platform'] = 'differential'  # 平台类型
```

### MPC 配置
```python
config['mpc']['horizon'] = 20           # MPC 预测步数
config['mpc']['horizon_degraded'] = 10  # 降级模式预测步数
config['mpc']['dt'] = 0.02              # MPC 时间步长
config['mpc']['weights']['position'] = 10.0   # 位置权重
config['mpc']['weights']['velocity'] = 1.0    # 速度权重
config['mpc']['weights']['heading'] = 5.0     # 航向权重
```

### MPC 健康监控
```python
config['mpc']['health_monitor']['time_warning_thresh_ms'] = 8    # 警告阈值
config['mpc']['health_monitor']['time_critical_thresh_ms'] = 15  # 临界阈值
config['mpc']['health_monitor']['time_recovery_thresh_ms'] = 6   # 恢复阈值
config['mpc']['health_monitor']['condition_number_thresh'] = 1e8 # 条件数阈值
config['mpc']['health_monitor']['consecutive_warning_limit'] = 3 # 连续警告限制
```

### 超时配置
```python
config['watchdog']['odom_timeout_ms'] = 200   # 里程计超时
config['watchdog']['traj_timeout_ms'] = 200   # 轨迹超时
config['watchdog']['traj_grace_ms'] = 100     # 轨迹宽限期
config['watchdog']['imu_timeout_ms'] = 100    # IMU 超时
config['watchdog']['startup_grace_ms'] = 1000 # 启动宽限期
```

### 一致性配置
```python
config['consistency']['kappa_thresh'] = 0.5        # 曲率阈值
config['consistency']['v_dir_thresh'] = 0.8        # 速度方向阈值
config['consistency']['temporal_smooth_thresh'] = 0.5  # 时序平滑阈值
config['consistency']['low_speed_thresh'] = 0.1    # 低速阈值
config['consistency']['alpha_min'] = 0.1           # α 最小值
config['consistency']['weights']['kappa'] = 1.0    # 曲率权重
config['consistency']['weights']['velocity'] = 1.5 # 速度权重
config['consistency']['weights']['temporal'] = 0.8 # 时序权重
```

### 安全配置
```python
config['safety']['v_stop_thresh'] = 0.05      # 停车速度阈值
config['safety']['vz_stop_thresh'] = 0.1      # 垂直停车阈值
config['safety']['stopping_timeout'] = 5.0    # 停车超时
config['safety']['emergency_decel'] = 3.0     # 紧急减速度
config['safety']['velocity_margin'] = 1.1     # 速度裕度
config['safety']['accel_margin'] = 1.5        # 加速度裕度

# 状态机配置
config['safety']['state_machine']['alpha_recovery_thresh'] = 5    # α 恢复计数
config['safety']['state_machine']['alpha_recovery_value'] = 0.3   # α 恢复值
config['safety']['state_machine']['alpha_disable_thresh'] = 0.1   # α 禁用阈值
config['safety']['state_machine']['mpc_recovery_thresh'] = 5      # MPC 恢复计数
config['safety']['state_machine']['mpc_fail_thresh'] = 3          # MPC 失败阈值
```

### 约束配置
```python
config['constraints']['v_max'] = 2.0          # 最大速度 (m/s)
config['constraints']['v_min'] = 0.0          # 最小速度
config['constraints']['omega_max'] = 2.0      # 最大角速度 (rad/s)
config['constraints']['omega_max_low'] = 1.0  # 低速最大角速度
config['constraints']['v_low_thresh'] = 0.1   # 低速阈值
config['constraints']['a_max'] = 1.5          # 最大加速度 (m/s²)
config['constraints']['az_max'] = 1.0         # 最大垂直加速度
config['constraints']['alpha_max'] = 3.0      # 最大角加速度 (rad/s²)
config['constraints']['vx_max'] = 1.5         # X 方向最大速度
config['constraints']['vy_max'] = 1.5         # Y 方向最大速度
config['constraints']['vz_max'] = 2.0         # Z 方向最大速度
```

### EKF 配置
```python
config['ekf']['use_odom_orientation_fallback'] = True  # 使用里程计航向回退
config['ekf']['theta_covariance_fallback_thresh'] = 0.5  # 航向协方差回退阈值
config['ekf']['adaptive']['base_slip_thresh'] = 2.0    # 滑移检测阈值
config['ekf']['adaptive']['slip_covariance_scale'] = 10.0  # 滑移协方差缩放
config['ekf']['measurement_noise']['odom_position'] = 0.01  # 里程计位置噪声
config['ekf']['measurement_noise']['odom_velocity'] = 0.1   # 里程计速度噪声
```

### 姿态控制配置 (四旋翼)
```python
config['attitude']['mass'] = 1.5              # 质量 (kg)
config['attitude']['gravity'] = 9.81          # 重力加速度
config['attitude']['roll_rate_max'] = 3.0     # 最大滚转角速度 (rad/s)
config['attitude']['pitch_rate_max'] = 3.0    # 最大俯仰角速度
config['attitude']['yaw_rate_max'] = 2.0      # 最大偏航角速度
config['attitude']['roll_max'] = 0.5          # 最大滚转角 (~30°)
config['attitude']['pitch_max'] = 0.5         # 最大俯仰角
config['attitude']['hover_yaw_compensation'] = True  # 悬停偏航补偿
config['attitude']['hover_speed_thresh'] = 0.1      # 悬停速度阈值
config['attitude']['hover_vz_thresh'] = 0.05        # 悬停垂直速度阈值
config['attitude']['thrust_min'] = 0.1        # 最小推力
config['attitude']['thrust_max'] = 2.0        # 最大推力
```

### 坐标变换配置
```python
config['transform']['target_frame'] = 'odom'  # 目标坐标系
config['transform']['source_frame'] = 'odom'  # 源坐标系
config['transform']['fallback_duration_limit_ms'] = 500   # 降级持续限制
config['transform']['fallback_critical_limit_ms'] = 1000  # 临界降级限制
config['transform']['tf2_timeout_ms'] = 10    # TF2 超时
config['transform']['tf2_required'] = False   # 是否强制要求 TF2
```

### 平滑过渡配置
```python
config['transition']['type'] = 'exponential'  # 过渡类型
config['transition']['tau'] = 0.1             # 时间常数
config['transition']['max_duration'] = 0.5    # 最大持续时间
config['transition']['completion_threshold'] = 0.95  # 完成阈值
```

### 备用控制器配置
```python
config['backup']['lookahead_dist'] = 1.0      # 前视距离
config['backup']['min_lookahead'] = 0.5       # 最小前视距离
config['backup']['max_lookahead'] = 3.0       # 最大前视距离
config['backup']['lookahead_ratio'] = 0.5     # 前视比例
config['backup']['kp_z'] = 1.0                # Z 方向增益
config['backup']['kp_heading'] = 1.5          # 航向增益
```

---

## 运行命令

```bash
# 运行示例
python -m universal_controller.main

# 启动 Dashboard
python -m universal_controller.dashboard.run_dashboard

# 运行所有测试
python universal_controller/tests/run_all_tests.py

# 运行单个测试
pytest universal_controller/tests/test_core.py -v
pytest universal_controller/tests/test_integration.py -v
```

---

## 诊断回调

```python
def on_diagnostics(diag):
    print(f"State: {diag['state']}")
    print(f"Alpha: {diag['consistency']['alpha_soft']:.3f}")
    print(f"MPC healthy: {diag['mpc_health']['is_healthy']}")
    print(f"Tracking error: {diag['tracking']['position_error']:.3f}")

manager.set_diagnostics_callback(on_diagnostics)
```

---

## 无人机姿态控制

```python
config['system']['platform'] = 'quadrotor'
manager = ControllerManager(config)
manager.initialize_default_components()

# 获取速度命令
cmd = manager.update(odom, trajectory)

# 计算姿态命令
attitude = manager.compute_attitude_command(
    cmd, 
    state, 
    yaw_mode='velocity'  # 或 'trajectory'
)

# 输出: attitude.roll, attitude.pitch, attitude.yaw, attitude.thrust
```

---

## 状态机转换

```
INIT ──────────────────────────────────────────────────────────────┐
  │                                                                │
  │ (初始化完成)                                                    │
  ▼                                                                │
NORMAL ◄──────────────────────────────────────────────────────┐    │
  │                                                           │    │
  │ (α < 0.1)              (MPC 连续失败 ≥ 3)                  │    │
  ▼                        ▼                                  │    │
SOFT_DISABLED ────────► MPC_DEGRADED                          │    │
  │                        │                                  │    │
  │ (超时)                 │ (MPC 持续失败)                    │    │
  ▼                        ▼                                  │    │
  │                    BACKUP_ACTIVE                          │    │
  │                        │                                  │    │
  │ (停车请求)             │ (停车请求)                        │    │
  ▼                        ▼                                  │    │
STOPPING ◄─────────────────┘                                  │    │
  │                                                           │    │
  │ (速度 < 阈值)                                              │    │
  ▼                                                           │    │
STOPPED ──────────────────────────────────────────────────────┘    │
  │                                                                │
  │ (重新初始化)                                                    │
  └────────────────────────────────────────────────────────────────┘
```

---

## 常用数据类型

```python
from universal_controller.core.data_types import (
    Pose3D,           # 3D 位姿
    Twist3D,          # 3D 速度
    TrajectoryPoint,  # 轨迹点
    ControlOutput,    # 控制输出
    AttitudeCommand,  # 姿态命令
    EstimatedState,   # 估计状态
)

from universal_controller.core.enums import (
    ControllerState,  # 控制器状态
    PlatformType,     # 平台类型
    DegradationLevel, # 降级等级
    MPCHealthStatus,  # MPC 健康状态
)
```

---

## 关键技术特性

| 特性 | 说明 |
|------|------|
| 单一时钟源 | 全局使用 `time.monotonic()` |
| 加速度滤波 | 一阶低通滤波 α=0.3 |
| MPC fail counter | 带衰减机制，防止状态抖动 |
| 悬停检测 | 滞回逻辑，防止频繁切换 |
| 四元数归一化 | 完整归一化，处理零向量 |
| Joseph 形式更新 | 数值稳定的 EKF 协方差更新 |
