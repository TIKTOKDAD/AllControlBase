# TurtleBot1 é…ç½®è¯Šæ–­ä¸è°ƒä¼˜å·¥å…·

è‡ªåŠ¨åˆ†ææ§åˆ¶å™¨è¯Šæ–­æ•°æ®ï¼Œè¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Œå¹¶ç”Ÿæˆä¼˜åŒ–åçš„é…ç½®æ–‡ä»¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“Š **è¯Šæ–­åˆ†æ**: åˆ†æ MPC æ€§èƒ½ã€è½¨è¿¹è·Ÿè¸ªè¯¯å·®ã€è¶…æ—¶é…ç½®ç­‰
- ğŸ”§ **è‡ªåŠ¨è°ƒä¼˜**: æ ¹æ®å®é™…è¿è¡Œæ•°æ®è‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–å»ºè®®
- ğŸ“ **é…ç½®ç”Ÿæˆ**: ç”Ÿæˆå®Œæ•´çš„ä¼˜åŒ–é…ç½® YAML æ–‡ä»¶
- ğŸ“ˆ **æŠ¥å‘Šè¾“å‡º**: è¯¦ç»†çš„è¯Šæ–­æŠ¥å‘Šå’Œåˆ†ææ‘˜è¦

## å‰ææ¡ä»¶

### å¿…éœ€ä¾èµ–

```bash
pip install numpy pyyaml
```

### å¯é€‰ä¾èµ–

```bash
# ç”¨äºè¯»å– ROS bag æ–‡ä»¶
pip install rosbag bagpy

# ç”¨äºå®æ—¶æ•°æ®æ”¶é›† (éœ€è¦ ROS ç¯å¢ƒ)
source /opt/ros/noetic/setup.bash
```

## ä½¿ç”¨æ–¹æ³•

### 1. ä» ROS bag æ–‡ä»¶åˆ†æ

```bash
# åŸºæœ¬ç”¨æ³•
python -m tools.tuning.run_diagnostics --bag /path/to/recording.bag

# æŒ‡å®šè¾“å‡ºç›®å½•
python -m tools.tuning.run_diagnostics --bag data.bag --output ./my_tuning
```

### 2. ä» JSON è¯Šæ–­æ•°æ®åˆ†æ

```bash
python -m tools.tuning.run_diagnostics --json /path/to/diagnostics.json
```

### 3. å®æ—¶æ”¶é›†å¹¶åˆ†æ

```bash
# éœ€è¦å…ˆå¯åŠ¨ ROS å’Œæ§åˆ¶å™¨
roslaunch controller_ros turtlebot1.launch

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œè¯Šæ–­å·¥å…·
python -m tools.tuning.run_diagnostics --live --duration 60
```

### 4. ä½¿ç”¨æ¼”ç¤ºæ•°æ®æµ‹è¯•

```bash
python -m tools.tuning.run_diagnostics --demo
```

## å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--bag` | ROS bag æ–‡ä»¶è·¯å¾„ | - |
| `--json` | JSON è¯Šæ–­æ•°æ®æ–‡ä»¶è·¯å¾„ | - |
| `--live` | ä»å®æ—¶ ROS è¯é¢˜æ”¶é›† | - |
| `--demo` | ä½¿ç”¨æ¼”ç¤ºæ•°æ®è¿è¡Œ | - |
| `--config` | é…ç½®æ–‡ä»¶è·¯å¾„ | `controller_ros/config/turtlebot1.yaml` |
| `--output` | è¾“å‡ºç›®å½• | `./tuning_output` |
| `--duration` | å®æ—¶æ”¶é›†æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰ | 60 |
| `--topic` | è¯Šæ–­è¯é¢˜åç§° | `/controller/diagnostics` |
| `--max-samples` | æœ€å¤§æ ·æœ¬æ•° | 10000 |

## è¾“å‡ºæ–‡ä»¶

è¿è¡Œåä¼šåœ¨è¾“å‡ºç›®å½•ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

```
tuning_output/
â”œâ”€â”€ tuned_turtlebot1.yaml      # ä¼˜åŒ–åçš„é…ç½®æ–‡ä»¶
â”œâ”€â”€ diagnostics_report.txt     # è¯¦ç»†è¯Šæ–­æŠ¥å‘Š
â”œâ”€â”€ analysis_summary.json      # åˆ†ææ‘˜è¦ (JSON æ ¼å¼)
â””â”€â”€ collected_diagnostics.json # æ”¶é›†çš„è¯Šæ–­æ•°æ® (ä»… --live æ¨¡å¼)
```

## åˆ†æå†…å®¹

### MPC æ€§èƒ½åˆ†æ

- æ±‚è§£æ—¶é—´ç»Ÿè®¡ (å¹³å‡ã€æœ€å¤§ã€95%åˆ†ä½)
- æˆåŠŸç‡åˆ†æ
- KKT æ®‹å·®å’Œæ¡ä»¶æ•°ç›‘æ§
- å¥åº·ç›‘æ§é˜ˆå€¼å»ºè®®

### è½¨è¿¹è·Ÿè¸ªåˆ†æ

- æ¨ªå‘è¯¯å·®åˆ†æ
- çºµå‘è¯¯å·®åˆ†æ
- èˆªå‘è¯¯å·®åˆ†æ
- MPC æƒé‡è°ƒä¼˜å»ºè®®

### è¶…æ—¶é…ç½®åˆ†æ

- é‡Œç¨‹è®¡å»¶è¿Ÿç»Ÿè®¡
- è½¨è¿¹å»¶è¿Ÿç»Ÿè®¡
- è¶…æ—¶é˜ˆå€¼å»ºè®®
- å®½é™æœŸé…ç½®å»ºè®®

### å®‰å…¨é…ç½®åˆ†æ

- é€Ÿåº¦çº¦æŸæ£€æŸ¥
- è§’é€Ÿåº¦çº¦æŸæ£€æŸ¥
- çŠ¶æ€æœºå‚æ•°åˆ†æ
- å¤‡ç”¨æ§åˆ¶å™¨æ¿€æ´»ç‡

## ç¤ºä¾‹è¾“å‡º

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         TurtleBot1 é…ç½®è¯Šæ–­ä¸è°ƒä¼˜å·¥å…· v1.0                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

============================================================
åˆ†ææ‘˜è¦
============================================================

æ ·æœ¬æ•°: 500

MPC æ€§èƒ½:
  - æˆåŠŸç‡: 90.2%
  - å¹³å‡æ±‚è§£æ—¶é—´: 12.5ms
  - 95%åˆ†ä½æ±‚è§£æ—¶é—´: 25.3ms
  - å¤‡ç”¨æ§åˆ¶å™¨æ¿€æ´»ç‡: 5.0%

è·Ÿè¸ªè¯¯å·®:
  - æ¨ªå‘: avg=8.2cm, max=15.3cm
  - çºµå‘: avg=15.1cm, max=32.5cm
  - èˆªå‘: avg=5.7Â°, max=12.3Â°

============================================================
ä¼˜åŒ–å»ºè®®
============================================================

ğŸŸ¡ è­¦å‘Š (2é¡¹):
  [mpc.weights.position]
    å½“å‰å€¼: 15.0 â†’ å»ºè®®å€¼: 19.5
    åŸå› : å¹³å‡æ¨ªå‘è¯¯å·®(8.2cm)è¾ƒå¤§ï¼Œå»ºè®®å¢åŠ ä½ç½®æƒé‡

  [mpc.weights.velocity]
    å½“å‰å€¼: 6.0 â†’ å»ºè®®å€¼: 7.8
    åŸå› : å¹³å‡çºµå‘è¯¯å·®(15.1cm)è¾ƒå¤§ï¼Œå»ºè®®å¢åŠ é€Ÿåº¦æƒé‡
```

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®è´¨é‡**: å»ºè®®æ”¶é›†è‡³å°‘ 100 ä¸ªæ ·æœ¬ä»¥è·å¾—å‡†ç¡®åˆ†æ
2. **è¿è¡Œåœºæ™¯**: å°½é‡åœ¨å…¸å‹è¿è¡Œåœºæ™¯ä¸‹æ”¶é›†æ•°æ®
3. **é…ç½®éªŒè¯**: ç”Ÿæˆçš„é…ç½®éœ€è¦åœ¨å®é™…ç¯å¢ƒä¸­éªŒè¯
4. **æ¸è¿›è°ƒä¼˜**: å»ºè®®é€æ­¥åº”ç”¨ä¼˜åŒ–å»ºè®®ï¼Œè€Œéä¸€æ¬¡æ€§å…¨éƒ¨åº”ç”¨

## çœŸå® ROS æ•°æ®è¯´æ˜

### æ•°æ®æ ¼å¼

å·¥å…·æ”¯æŒä¸¤ç§æ•°æ®æ ¼å¼ï¼š

1. **ROS DiagnosticsV2 æ¶ˆæ¯** (çœŸå®æ•°æ®)
   - æ¥è‡ª `/controller/diagnostics` è¯é¢˜
   - ä½¿ç”¨æ‰å¹³åŒ–å­—æ®µå (å¦‚ `timeout_odom`, `mpc_health_kkt_residual`)
   - å·¥å…·ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºåµŒå¥—æ ¼å¼è¿›è¡Œåˆ†æ

2. **Demo/æµ‹è¯•æ•°æ®**
   - ä½¿ç”¨åµŒå¥—å­—å…¸æ ¼å¼
   - åŒ…å«é¢å¤–å­—æ®µå¦‚ `trajectory.point_count`, `cycle_time_ms`

### çœŸå®æ•°æ®ä¸­ä¸åŒ…å«çš„å­—æ®µ

ä»¥ä¸‹å­—æ®µä»…åœ¨ demo æ•°æ®ä¸­å­˜åœ¨ï¼ŒçœŸå® ROS è¯Šæ–­æ•°æ®ä¸åŒ…å«ï¼š

- `trajectory.point_count` - è½¨è¿¹ç‚¹æ•°
- `trajectory.dt_sec` - è½¨è¿¹æ—¶é—´æ­¥é•¿
- `cycle_time_ms` - æ§åˆ¶å‘¨æœŸæ—¶é—´

è¿™äº›å­—æ®µçš„ç¼ºå¤±ä¸ä¼šå½±å“æ ¸å¿ƒåˆ†æåŠŸèƒ½ï¼Œå·¥å…·ä¼šè‡ªåŠ¨è·³è¿‡ç›¸å…³æ£€æŸ¥ã€‚

### æ”¶é›†çœŸå®æ•°æ®çš„æ­¥éª¤

```bash
# 1. å¯åŠ¨ ROS æ ¸å¿ƒ
roscore

# 2. å¯åŠ¨æ§åˆ¶å™¨
roslaunch controller_ros turtlebot1.launch

# 3. å‘å¸ƒè½¨è¿¹ (æ ¹æ®ä½ çš„è½¨è¿¹æº)
# ä¾‹å¦‚: rosrun your_planner trajectory_publisher

# 4. è¿è¡Œè¯Šæ–­å·¥å…·æ”¶é›†æ•°æ®
python -m tools.tuning.run_diagnostics --live --duration 120

# æˆ–è€…å…ˆå½•åˆ¶ bag æ–‡ä»¶ï¼Œä¹‹ååˆ†æ
rosbag record /controller/diagnostics -O diagnostics.bag
# ... è¿è¡Œä¸€æ®µæ—¶é—´å Ctrl+C åœæ­¢
python -m tools.tuning.run_diagnostics --bag diagnostics.bag
```

## æ–‡ä»¶ç»“æ„

```
tools/tuning/
â”œâ”€â”€ __init__.py              # åŒ…åˆå§‹åŒ–
â”œâ”€â”€ run_diagnostics.py       # ä¸»å…¥å£è„šæœ¬
â”œâ”€â”€ diagnostics_analyzer.py  # è¯Šæ–­åˆ†æå™¨
â”œâ”€â”€ config_generator.py      # é…ç½®ç”Ÿæˆå™¨
â”œâ”€â”€ data_collector.py        # æ•°æ®æ”¶é›†å™¨
â””â”€â”€ README.md                # æœ¬æ–‡æ¡£
```

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„åˆ†æé¡¹

åœ¨ `diagnostics_analyzer.py` ä¸­æ·»åŠ æ–°çš„åˆ†ææ–¹æ³•ï¼š

```python
def _analyze_new_feature(self):
    """åˆ†ææ–°ç‰¹æ€§"""
    # è·å–ç›¸å…³æ•°æ®
    # æ‰§è¡Œåˆ†æ
    # æ·»åŠ ç»“æœ
    self.results.append(AnalysisResult(
        category="new_category",
        severity="warning",
        parameter="config.path",
        current_value=current,
        suggested_value=suggested,
        reason="åŸå› è¯´æ˜",
        confidence=0.8
    ))
```

### è‡ªå®šä¹‰æ•°æ®æ”¶é›†å™¨

ç»§æ‰¿ `DataCollector` åŸºç±»å®ç°è‡ªå®šä¹‰æ”¶é›†å™¨ï¼š

```python
class CustomCollector(DataCollector):
    def collect(self, **kwargs) -> int:
        # å®ç°æ•°æ®æ”¶é›†é€»è¾‘
        return len(self.samples)
```
