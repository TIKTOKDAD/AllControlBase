# TurtleBot1 控制器配置优化建议

## 诊断数据汇总

### 模式1: 基础调优 (day1)
- **里程计**: 49.9 Hz, 延迟 0.3ms, 抖动 0.6ms ✅
- **轨迹**: 10.2 Hz, 8点, dt=0.1s ✅
- **IMU**: 无数据 ⚠️
- **底盘**: 未移动 (被动监听)

### 模式2: 底盘测试 (day2_chassis)
- **里程计**: 49.9 Hz, 延迟 0.5ms, 抖动 0.6ms ✅
- **实测最大速度**: 0.46 m/s ✅
- **实测最大加速度**: 12.06 m/s² ⚠️ (异常高)
- **实测最大角速度**: 0.74 rad/s ✅
- **响应时间**: 0.162 sec ✅

### 模式3: 运行时调优 (runtime_tuning)
- **里程计**: 50.0 Hz, 延迟 0.5ms, 抖动 2.1ms ✅
- **轨迹**: 2.7 Hz, 延迟 0.5ms, 抖动 367ms ⚠️
- **实际运行速度**: 0.48 m/s
- **实际角速度**: 1.89 rad/s
- **实际加速度**: 3.69 m/s²
- **MPC求解时间**: 1.69ms avg, 13.04ms max ✅
- **MPC成功率**: 100% ✅
- **横向误差**: 9.9cm avg, 33.8cm max ✅
- **航向误差**: 6.9° avg ✅

---

## 🎯 推荐最终配置

基于三次诊断的综合分析，推荐使用 **runtime_tuned_config.yaml** 作为基础，并进行以下关键调整：

### 1. 系统核心参数 ✅

```yaml
system:
  ctrl_freq: 40  # 运行时验证良好，保持40Hz
  platform: differential
```

**理由**: 
- 里程计稳定在50Hz，支持40Hz控制频率
- 运行时MPC求解时间仅1.69ms，远低于25ms限制
- 40Hz提供更好的响应性和跟踪精度

---

### 2. 速度与加速度约束 ⚠️ **需要调整**

#### 当前问题分析：
- **day2测试异常**: 加速度12.06 m/s²明显不合理（可能是测试时间过短或数据噪声）
- **runtime实测**: 加速度3.69 m/s²更接近真实值
- **速度一致性**: 三次测试速度都在0.46-0.48 m/s范围

#### 推荐配置：

```yaml
constraints:
  v_max: 0.40          # 从0.38调整到0.40 (留10%安全裕度)
  v_min: -0.20         # 保持
  omega_max: 1.60      # 从1.51调整到1.60 (实测1.89的85%)
  omega_max_low: 0.80  # omega_max的50%
  a_max: 3.00          # 从2.95调整到3.00 (实测3.69的81%)
  alpha_max: 15.00     # 从19.03降低到15.00 (更保守)
  v_low_thresh: 0.10   # 保持
```

**调整理由**:
1. **v_max**: 实测0.48 m/s，设置0.40留有安全裕度
2. **omega_max**: 实测1.89 rad/s，设置1.60 (85%使用率)
3. **a_max**: 忽略day2的12.06异常值，采用runtime的3.69，设置3.00
4. **alpha_max**: 降低角加速度限制，提高转弯平滑性

---

### 3. 安全参数 ⚠️ **需要调整**

```yaml
safety:
  v_stop_thresh: 0.05
  vz_stop_thresh: 0.1
  stopping_timeout: 5.0
  emergency_decel: 4.50        # 从5.54降低到4.50 (更平滑)
  low_speed:
    threshold: 0.10
    omega_limit: 1.00          # 从0.95调整到1.00
  margins:
    velocity: 1.15             # 从1.1调整到1.15 (更保守)
    acceleration: 1.25         # 从1.5降低到1.25 (更保守)
```

**调整理由**:
1. **emergency_decel**: 降低紧急制动加速度，避免急停
2. **margins**: 提高速度裕度，降低加速度裕度（因为实测加速度较高）

---

### 4. MPC参数 ✅ **保持良好**

```yaml
mpc:
  horizon: 7                   # 保持 (轨迹8点，horizon=7合适)
  horizon_degraded: 3          # 保持
  dt: 0.10000000149011612      # 保持 (与轨迹dt匹配)
  weights:
    position: 10.0             # 保持
    velocity: 1.0              # 保持
    heading: 5.0               # 保持
    control_accel: 0.2         # 保持
    control_alpha: 0.2         # 保持
  health_monitor:
    time_warning_thresh_ms: 10    # 保持 (MPC平均1.69ms)
    time_critical_thresh_ms: 20   # 保持
    time_recovery_thresh_ms: 7    # 保持
```

**理由**: 
- MPC求解时间1.69ms，成功率100%，无需调整
- horizon=7与轨迹点数8匹配良好

---

### 5. 超时参数 ⚠️ **需要调整**

```yaml
watchdog:
  odom_timeout_ms: 60          # 保持 (50Hz里程计，60ms=3个周期)
  traj_timeout_ms: 500         # 从751降低到500 (轨迹2.7Hz不稳定)
  traj_grace_ms: 250           # 从375降低到250
  imu_timeout_ms: -1           # 保持 (无IMU)
  startup_grace_ms: 5000       # 保持
```

**调整理由**:
- **轨迹抖动严重**: 367ms抖动，2.7Hz频率不稳定
- **降低超时**: 500ms可以更快检测轨迹丢失
- **traj_grace**: 设置为超时的50%

---

### 6. 一致性检查 ⚠️ **需要调整**

```yaml
consistency:
  kappa_thresh: 0.5
  v_dir_thresh: 0.8
  temporal_smooth_thresh: 0.4  # 从0.3调整到0.4 (轨迹抖动大)
  alpha_min: 0.1
  max_curvature: 10.0
  temporal_window_size: 10
  weights:
    kappa: 0.3
    velocity: 0.3
    temporal: 0.4
```

**调整理由**:
- 轨迹抖动367ms，需要放宽时间平滑阈值

---

### 7. 备用控制器 ✅ **保持良好**

```yaml
backup:
  lookahead_dist: 0.30         # 保持
  min_lookahead: 0.18          # 保持
  max_lookahead: 0.90          # 保持
  dt: 0.025                    # 保持 (40Hz控制频率)
  heading_kp: 1.5              # 保持
  max_curvature: 5.0           # 保持
```

**理由**: 备用控制器使用率0%，说明MPC工作良好

---

### 8. EKF参数 ⚠️ **需要调整**

```yaml
ekf:
  use_odom_orientation_fallback: true
  imu_motion_compensation: false
  process_noise:
    position: 0.0026           # 从0.0027调整 (里程计抖动2.1ms)
    velocity: 0.0130           # 从0.0131调整
    orientation: 0.0105        # 从0.0106调整
    angular_velocity: 0.1
  measurement_noise:
    odom_position: 0.0026      # 与process_noise保持一致
    odom_velocity: 0.0130
```

**调整理由**:
- 里程计抖动从0.6ms增加到2.1ms（运行时）
- 略微增加噪声估计以适应实际情况

---

### 9. 过渡控制 ✅ **保持良好**

```yaml
transition:
  type: exponential
  tau: 0.05                    # 保持 (40Hz控制频率)
  max_duration: 0.5
  completion_threshold: 0.95
```

---

### 10. 跟踪阈值 ✅ **保持良好**

```yaml
tracking:
  lateral_thresh: 0.30         # 保持 (实测9.9cm avg, 33.8cm max)
  longitudinal_thresh: 0.50    # 保持
  heading_thresh: 0.50         # 保持
```

**理由**: 实测横向误差33.8cm max，阈值30cm合理

---

## 🚨 关键问题与建议

### 1. IMU缺失 ⚠️
**问题**: 三次诊断都没有IMU数据
**影响**: 
- 无法进行运动补偿
- 姿态估计完全依赖里程计
- 快速转弯时精度下降

**建议**: 
- 检查IMU话题是否发布: `rostopic echo /imu`
- 如果TurtleBot1没有IMU，保持当前配置
- 如果有IMU但未连接，建议连接以提高性能

---

### 2. 轨迹抖动严重 ⚠️
**问题**: 轨迹延迟抖动367ms，频率仅2.7Hz
**影响**: 
- 控制不稳定
- 可能导致跟踪误差增大

**建议**: 
- 检查轨迹发布节点性能
- 考虑增加轨迹发布频率到5-10Hz
- 检查网络延迟（如果轨迹来自远程）

---

### 3. 底盘测试加速度异常 ⚠️
**问题**: day2测试显示12.06 m/s²，但runtime仅3.69 m/s²
**原因**: 
- 测试时间过短（5秒）
- 可能包含噪声或瞬时冲击
- 计算方法差异

**建议**: 
- 采用runtime的3.69 m/s²作为真实值
- 忽略day2的12.06 m/s²异常数据

---

### 4. 控制频率选择 ✅
**当前**: 40Hz
**验证**: 
- MPC求解时间1.69ms << 25ms (40Hz周期)
- 里程计50Hz稳定
- 成功率100%

**建议**: 保持40Hz，性能优秀

---

## 📋 实施步骤

### 步骤1: 创建最终配置文件

```bash
# 复制runtime配置作为基础
cp ~/moshi/runtime_tuned_config.yaml ~/moshi/final_config.yaml

# 手动编辑以下参数（参考上述建议）
nano ~/moshi/final_config.yaml
```

### 步骤2: 需要手动修改的参数

```yaml
# 1. 速度约束
constraints:
  v_max: 0.40
  omega_max: 1.60
  omega_max_low: 0.80
  a_max: 3.00
  alpha_max: 15.00

# 2. 安全参数
safety:
  emergency_decel: 4.50
  low_speed:
    omega_limit: 1.00
  margins:
    velocity: 1.15
    acceleration: 1.25

# 3. 超时参数
watchdog:
  traj_timeout_ms: 500
  traj_grace_ms: 250

# 4. 一致性检查
consistency:
  temporal_smooth_thresh: 0.4

# 5. EKF噪声
ekf:
  process_noise:
    position: 0.0026
    velocity: 0.0130
    orientation: 0.0105
  measurement_noise:
    odom_position: 0.0026
    odom_velocity: 0.0130
```

### 步骤3: 测试新配置

```bash
# 终端1: 启动TurtleBot
roslaunch turtlebot_bringup minimal.launch

# 终端2: 启动控制器（使用新配置）
roslaunch controller_ros turtlebot1.launch config:=~/moshi/final_config.yaml

# 终端3: 启动轨迹发布器
rosrun your_package trajectory_publisher.py

# 终端4: 监控诊断
rostopic echo /controller/diagnostics
```

### 步骤4: 验证性能

观察以下指标：
- ✅ MPC求解时间 < 10ms
- ✅ MPC成功率 > 95%
- ✅ 横向误差 < 30cm
- ✅ 航向误差 < 10°
- ✅ 无频繁降级到备用控制器

---

## 📊 配置对比表

| 参数 | day1 | day2_chassis | runtime | **推荐值** |
|------|------|--------------|---------|-----------|
| ctrl_freq | 20 Hz | 20 Hz | 40 Hz | **40 Hz** ✅ |
| v_max | 0.40 m/s | 0.37 m/s | 0.38 m/s | **0.40 m/s** |
| omega_max | 0.0 rad/s | 0.59 rad/s | 1.51 rad/s | **1.60 rad/s** |
| a_max | 0.40 m/s² | 9.65 m/s² | 2.95 m/s² | **3.00 m/s²** |
| alpha_max | 0.25 rad/s² | 0.8 rad/s² | 19.03 rad/s² | **15.00 rad/s²** |
| emergency_decel | 0.75 m/s² | 18.1 m/s² | 5.54 m/s² | **4.50 m/s²** |
| traj_timeout_ms | 196 ms | 1000 ms | 751 ms | **500 ms** |
| MPC horizon | 7 | 3 | 7 | **7** ✅ |

---

## 🎓 总结

### 优点 ✅
1. **MPC性能优秀**: 求解时间1.69ms，成功率100%
2. **里程计稳定**: 50Hz频率，低延迟低抖动
3. **跟踪精度良好**: 横向误差9.9cm平均值
4. **控制频率合理**: 40Hz提供良好响应性

### 需要改进 ⚠️
1. **IMU缺失**: 考虑添加IMU以提高姿态估计
2. **轨迹抖动**: 优化轨迹发布节点，提高频率和稳定性
3. **参数保守性**: 当前配置偏保守，可以根据实际需求微调

### 下一步 🚀
1. 应用推荐配置并测试
2. 监控长时间运行稳定性
3. 根据实际场景微调速度和加速度限制
4. 考虑添加IMU传感器

---

**生成时间**: 2024-12-29  
**基于诊断**: day1.log, day2_chassis.log, runtime_tuning.log  
**推荐配置**: 基于runtime_tuned_config.yaml + 上述调整
