# ============================================================================
# 最终优化配置 - 基于三次诊断结果
# 生成时间: 2024-12-29
# ============================================================================
#
# 诊断数据汇总:
#   模式1 (day1): 基础调优 - 里程计49.9Hz, 轨迹10.2Hz
#   模式2 (day2_chassis): 底盘测试 - 实测v_max=0.46m/s, omega_max=0.74rad/s
#   模式3 (runtime): 运行时调优 - MPC成功率100%, 横向误差9.9cm
#
# 关键发现:
#   ✅ MPC性能优秀: 1.69ms求解时间, 100%成功率
#   ✅ 里程计稳定: 50Hz, 延迟0.5ms, 抖动2.1ms
#   ✅ 跟踪精度良好: 横向误差avg=9.9cm, max=33.8cm
#   ⚠️ 轨迹抖动严重: 367ms抖动, 2.7Hz频率
#   ⚠️ IMU缺失: 无IMU数据
#   ⚠️ day2加速度异常: 12.06m/s²不可信，采用runtime的3.69m/s²
#
# 主要调整 (相比runtime_tuned_config.yaml):
#   1. v_max: 0.38 → 0.40 (留10%裕度)
#   2. omega_max: 1.51 → 1.60 (实测1.89的85%)
#   3. a_max: 2.95 → 3.00 (实测3.69的81%)
#   4. alpha_max: 19.03 → 15.00 (更保守，提高平滑性)
#   5. emergency_decel: 5.54 → 4.50 (更平滑的紧急制动)
#   6. traj_timeout_ms: 751 → 500 (更快检测轨迹丢失)
#   7. temporal_smooth_thresh: 0.3 → 0.4 (适应轨迹抖动)
#   8. safety margins: 更保守的安全裕度
#
# ============================================================================

system:
  ctrl_freq: 40  # 保持40Hz - MPC求解时间仅1.69ms，性能优秀
  platform: differential

topics:
  odom: /odom
  imu: ''  # 无IMU数据
  trajectory: /nn/local_trajectory
  emergency_stop: /controller/emergency_stop
  cmd_unified: /cmd_unified
  diagnostics: /controller/diagnostics
  state: /controller/state

tf:
  source_frame: base_link
  target_frame: odom
  timeout_ms: 50
  buffer_warmup_timeout_sec: 5.0
  buffer_warmup_interval_sec: 0.2
  expected_source_frames:
  - base_link
  - base_footprint
  - ''

watchdog:
  odom_timeout_ms: 59  # 50Hz里程计，60ms=3个周期
  traj_timeout_ms: 500  # 从751降低到500 - 轨迹抖动严重，更快检测丢失
  traj_grace_ms: 250    # 从375降低到250 - 超时的50%
  imu_timeout_ms: -1    # 无IMU
  startup_grace_ms: 5000

mpc:
  horizon: 7  # 保持 - 轨迹8点，horizon=7合适
  horizon_degraded: 3
  dt: 0.10000000149011612  # 与轨迹dt匹配
  weights:
    position: 10.0
    velocity: 1.0
    heading: 5.0
    control_accel: 0.2
    control_alpha: 0.2
  solver:
    nlp_max_iter: 50
    qp_solver: PARTIAL_CONDENSING_HPIPM
    integrator_type: ERK
    nlp_solver_type: SQP_RTI
  health_monitor:
    time_warning_thresh_ms: 10   # MPC平均1.69ms，阈值合理
    time_critical_thresh_ms: 20
    time_recovery_thresh_ms: 7
    condition_number_thresh: 100000000.0
    condition_number_recovery: 100000.0
    kkt_residual_thresh: 0.001
    consecutive_warning_limit: 10
    consecutive_recovery_limit: 5
    recovery_multiplier: 2.0
    consecutive_good_for_decay: 2
    timeout_decay_rate: 2
  fallback:
    lookahead_steps: 3
    heading_kp: 1.5
    max_curvature: 5.0
    min_distance_thresh: 0.1
    min_turn_speed: 0.1
    default_speed_ratio: 0.5

constraints:
  v_max: 0.40           # 从0.38调整 - 实测0.48，留10%裕度
  v_min: -0.20
  omega_max: 1.60       # 从1.51调整 - 实测1.89，使用85%
  omega_max_low: 0.80   # omega_max的50%
  a_max: 3.00           # 从2.95调整 - 实测3.69，使用81%
  alpha_max: 15.00      # 从19.03降低 - 更保守，提高转弯平滑性
  v_low_thresh: 0.10

safety:
  v_stop_thresh: 0.05
  vz_stop_thresh: 0.1
  stopping_timeout: 5.0
  emergency_decel: 4.50  # 从5.54降低 - 更平滑的紧急制动
  low_speed:
    threshold: 0.10
    omega_limit: 1.00    # 从0.95调整
  margins:
    velocity: 1.15       # 从1.1调整 - 更保守的速度裕度
    acceleration: 1.25   # 从1.5降低 - 更保守的加速度裕度
  accel_filter_window: 3
  accel_filter_alpha: 0.3
  accel_filter_warmup_alpha: 0.5
  accel_filter_warmup_period: 3
  min_dt_for_accel: 0.001
  max_dt_for_accel: 1.0
  state_machine:
    alpha_disable_thresh: 0.0
    alpha_recovery_value: 0.0
    alpha_recovery_thresh: 5
    mpc_recovery_thresh: 5
    mpc_fail_window_size: 10
    mpc_fail_thresh: 3
    mpc_fail_ratio_thresh: 0.5
    mpc_recovery_history_min: 3
    mpc_recovery_recent_count: 5
    mpc_recovery_tolerance: 0
    mpc_recovery_success_ratio: 0.8

consistency:
  kappa_thresh: 0.5
  v_dir_thresh: 0.8
  temporal_smooth_thresh: 0.4  # 从0.3调整 - 适应轨迹抖动367ms
  alpha_min: 0.1
  max_curvature: 10.0
  temporal_window_size: 10
  weights:
    kappa: 0.3
    velocity: 0.3
    temporal: 0.4

ekf:
  use_odom_orientation_fallback: true
  imu_motion_compensation: false
  process_noise:
    position: 0.0026     # 适应里程计抖动2.1ms
    velocity: 0.0130
    orientation: 0.0105
    angular_velocity: 0.1
  measurement_noise:
    odom_position: 0.0026
    odom_velocity: 0.0130

transform:
  target_frame: odom
  source_frame: base_link
  timeout_ms: 50
  fallback_duration_limit_ms: 500
  fallback_critical_limit_ms: 1000
  drift_estimation_enabled: false
  recovery_correction_enabled: true
  drift_rate: 0.01
  drift_velocity_factor: 0.1
  max_drift_dt: 0.5
  drift_correction_thresh: 0.01
  expected_source_frames:
  - base_link
  - base_footprint
  - base_link_0
  - ''
  - odom
  warn_unexpected_frame: true

transition:
  type: exponential
  tau: 0.05  # 适配40Hz控制频率
  max_duration: 0.5
  completion_threshold: 0.95
  duration: 0.2

backup:
  lookahead_dist: 0.30
  min_lookahead: 0.18
  max_lookahead: 0.90
  lookahead_ratio: 0.5
  kp_z: 1.0
  kp_heading: 1.5
  heading_mode: follow_velocity
  dt: 0.025  # 40Hz控制频率
  heading_error_thresh: 1.047
  pure_pursuit_angle_thresh: 1.047
  heading_control_angle_thresh: 1.571
  max_curvature: 5.0
  min_turn_speed: 0.1
  default_speed_ratio: 0.5
  low_speed_transition_factor: 0.5
  curvature_speed_limit_thresh: 0.1
  min_distance_thresh: 0.1
  omega_rate_limit: null

tracking:
  lateral_thresh: 0.30      # 实测max=33.8cm，阈值合理
  longitudinal_thresh: 0.50
  heading_thresh: 0.50
  prediction_thresh: 0.50
  weights:
    lateral: 0.4
    longitudinal: 0.4
    heading: 0.2
  rating:
    excellent: 90
    good: 70
    fair: 50

cmd_vel_adapter:
  publish_rate: 40.0  # 匹配控制频率
  joy_timeout: 0.5
  max_linear: 0.40    # 匹配v_max
  max_angular: 1.60   # 匹配omega_max
  max_linear_accel: 0.0
  max_angular_accel: 0.0
  input_topic: /cmd_unified
  joy_topic: /joy_cmd_vel
  mode_topic: /visualizer/control_mode
  output_topic: /cmd_vel

diagnostics:
  publish_rate: 10

# ============================================================================
# 使用方法:
#   roslaunch controller_ros turtlebot1.launch config:=~/moshi/final_optimized_config.yaml
#
# 验证指标:
#   ✅ MPC求解时间 < 10ms
#   ✅ MPC成功率 > 95%
#   ✅ 横向误差 < 30cm
#   ✅ 航向误差 < 10°
#   ✅ 无频繁降级到备用控制器
#
# 后续优化建议:
#   1. 添加IMU以提高姿态估计精度
#   2. 优化轨迹发布节点，提高频率到5-10Hz，降低抖动
#   3. 根据实际场景微调速度和加速度限制
#   4. 长时间运行测试稳定性
# ============================================================================
